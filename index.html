<!doctype html>
<html lang="ar" dir="rtl" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام نقاط البيع والمحاسبة</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    
    .sidebar-item {
      transition: all 0.2s ease;
    }
    
    .sidebar-item:hover {
      background-color: rgba(102, 126, 234, 0.1);
      transform: translateX(-5px);
    }
    
    .sidebar-item.active {
      background-color: rgba(102, 126, 234, 0.2);
      border-right: 4px solid #667eea;
    }
    
    [dir="ltr"] .sidebar-item.active {
      border-right: none;
      border-left: 4px solid #667eea;
    }
    
    [dir="ltr"] .sidebar-item:hover {
      transform: translateX(5px);
    }
    
    .modal-overlay {
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }
    
    .product-card {
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .product-card:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }
    
    @media print {
      body * {
        visibility: hidden;
      }
      #printArea, #printArea * {
        visibility: visible;
      }
      #printArea {
        position: absolute;
        left: 0;
        top: 0;
        width: 80mm;
      }
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 9999;
      animation: slideIn 0.3s ease;
    }
    
    [dir="ltr"] .toast {
      right: auto;
      left: 20px;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .number-input {
      direction: ltr;
      text-align: center;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full w-full overflow-auto bg-gray-50">
  <div id="app" class="h-full w-full"></div>
  <script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyAxjBBtAnpThJoliccuoq0NNIABGPv1dJg",
  authDomain: "fawatir-b6119.firebaseapp.com",
  databaseURL: "https://fawatir-b6119-default-rtdb.firebaseio.com",
  projectId: "fawatir-b6119",
  storageBucket: "fawatir-b6119.firebasestorage.app",
  messagingSenderId: "575777677956",
  appId: "1:575777677956:web:74794fdd3525f2693d18d1",
  measurementId: "G-N3WQQC8XY5"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Global State
let currentLang = 'ar';
let currentScreen = 'home';
let currentPage = 'orders';
let allRecords = [];
let currentInvoice = null;
let selectedProducts = [];
let deviceId = null;
let deviceBranch = null;
let currentCashier = null;

// Translations
const translations = {
  ar: {
    home: 'الصفحة الرئيسية',
    cashier: 'الكاشير',
    accounting: 'المحاسبة والمخازن',
    orders: 'الطلبات',
    customers: 'العملاء',
    products: 'المنتجات',
    categories: 'الأقسام',
    devices: 'الأجهزة والكاشير',
    logout: 'تسجيل الخروج',
    add: 'إضافة',
    edit: 'تعديل',
    delete: 'حذف',
    save: 'حفظ',
    cancel: 'إلغاء',
    search: 'بحث',
    close: 'إغلاق',
    newInvoice: 'فاتورة جديدة',
    delivery: 'توصيل',
    pickup: 'استلام',
    next: 'التالي',
    print: 'طباعة',
    total: 'الإجمالي',
    kwd: 'د.ك',
    addProduct: 'إضافة منتج',
    addCategory: 'إضافة قسم',
    addSubCategory: 'إضافة قسم فرع��',
    addCustomer: 'إضافة عميل',
    productNameAr: 'اسم المنتج بالعربي',
    productNameEn: 'اسم المنتج بالإنجليزي',
    salePrice: 'سعر البيع',
    unit: 'الوحدة',
    quantity: 'الكمية',
    categoryNameAr: 'اسم القسم بالعربي',
    categoryNameEn: 'اسم القسم بالإنجليزي',
    customerName: 'اسم الزبون',
    phoneNumber: 'رقم الهاتف',
    countryCode: 'فتح الخط',
    area: 'المنطقة',
    addressDetail: 'تفاصيل العنوان',
    invoiceNumber: 'رقم الفاتورة',
    date: 'التاريخ',
    branch: 'الفرع',
    cashierName: 'اسم الكاشير',
    mainBranch: 'الفرع الرئيسي',
    abuHasaniya: 'أبو الحصانية',
    yarmouk: 'اليرموك',
    selectBranch: 'اختر الفرع',
    deviceNotDefined: 'الجهاز غير معرف',
    addCashier: 'إضافة كاشير',
    generate: 'إنشاء',
    cashierCode: 'رمز الكاشير',
    openInvoices: 'الفواتير المفتوحة',
    downloadExcel: 'تحميل تقرير Excel',
    filterBy: 'تصفية حسب',
    allBranches: 'جميع الفروع',
    allCashiers: 'جميع الكاشيرين',
    from: 'من',
    to: 'إلى',
    totalRevenue: 'إجمالي الإيرادات'
  },
  en: {
    home: 'Home',
    cashier: 'Cashier',
    accounting: 'Accounting & Warehouse',
    orders: 'Orders',
    customers: 'Customers',
    products: 'Products',
    categories: 'Categories',
    devices: 'Devices & Cashiers',
    logout: 'Logout',
    add: 'Add',
    edit: 'Edit',
    delete: 'Delete',
    save: 'Save',
    cancel: 'Cancel',
    search: 'Search',
    close: 'Close',
    newInvoice: 'New Invoice',
    delivery: 'Delivery',
    pickup: 'Pickup',
    next: 'Next',
    print: 'Print',
    total: 'Total',
    kwd: 'KWD',
    addProduct: 'Add Product',
    addCategory: 'Add Category',
    addSubCategory: 'Add Sub-Category',
    addCustomer: 'Add Customer',
    productNameAr: 'Product Name (Arabic)',
    productNameEn: 'Product Name (English)',
    salePrice: 'Sale Price',
    unit: 'Unit',
    quantity: 'Quantity',
    categoryNameAr: 'Category Name (Arabic)',
    categoryNameEn: 'Category Name (English)',
    customerName: 'Customer Name',
    phoneNumber: 'Phone Number',
    countryCode: 'Country Code',
    area: 'Area',
    addressDetail: 'Address Details',
    invoiceNumber: 'Invoice Number',
    date: 'Date',
    branch: 'Branch',
    cashierName: 'Cashier Name',
    mainBranch: 'Main Branch',
    abuHasaniya: 'Abu Hasaniya',
    yarmouk: 'Yarmouk',
    selectBranch: 'Select Branch',
    deviceNotDefined: 'Device Not Defined',
    addCashier: 'Add Cashier',
    generate: 'Generate',
    cashierCode: 'Cashier Code',
    openInvoices: 'Open Invoices',
    downloadExcel: 'Download Excel Report',
    filterBy: 'Filter By',
    allBranches: 'All Branches',
    allCashiers: 'All Cashiers',
    from: 'From',
    to: 'To',
    totalRevenue: 'Total Revenue'
  }
};

const translate = (key) => translations[currentLang][key] || key;

// Units
const units = ['كيلو', 'لتر', 'جرام', 'حبة', 'ربطة', 'كرتون', 'تنكة'];

// Areas with prices
const areas = [
  { name: 'السرة', price: 0.5 },
  { name: 'الزهراء', price: 1 },
  { name: 'السلام', price: 1 },
  { name: 'حطين', price: 1 },
  { name: 'الفيحاء', price: 1 },
  { name: 'القادسية', price: 1 },
  { name: 'مشرف', price: 1 },
  { name: 'كيفان', price: 1 },
  { name: 'الروضة', price: 1 },
  { name: 'العديلية', price: 1 },
  { name: 'الخا��دية', price: 1 },
  { name: 'النزهة', price: 1 },
  { name: 'الدعية', price: 1 },
  { name: 'المنصورية', price: 1 },
  { name: 'قرطبة', price: 1 },
  { name: 'الشامية', price: 1 },
  { name: 'الرميثية', price: 1 },
  { name: 'عبدالله السالم', price: 1 },
  { name: 'الجابرية', price: 1 },
  { name: 'بيان', price: 1 },
  { name: 'الصديق', price: 1 },
  { name: 'الشهداء', price: 1 },
  { name: 'اليرموك', price: 1 },
  { name: 'الفروانية', price: 2 },
  { name: 'خيطان', price: 2 },
  { name: 'بنيد القار', price: 2 },
  { name: 'الدسمة', price: 2 },
  { name: 'حولي', price: 2 },
  { name: 'ميدان حولي', price: 2 },
  { name: 'مبارك الكبير', price: 2 },
  { name: 'القصور', price: 2 },
  { name: 'الرابية', price: 2 },
  { name: 'العمرية', price: 2 },
  { name: 'الرقعي', price: 2 },
  { name: 'غرناطة', price: 2 },
  { name: 'القرين', price: 2 },
  { name: 'الشويخ', price: 2 },
  { name: 'المسيلة', price: 2 },
  { name: 'الكويت', price: 2 },
  { name: 'اشبيليا', price: 2 },
  { name: 'السالمية', price: 2 },
  { name: 'شرق', price: 2 },
  { name: 'الرحاب', price: 2 },
  { name: 'المرقاب', price: 2 },
  { name: 'صباح السالم', price: 2 },
  { name: 'الفردوس', price: 2 },
  { name: 'صباح الناصر', price: 2 },
  { name: 'المسايل', price: 2 },
  { name: 'الاندلس', price: 2 },
  { name: 'العارضية', price: 2 },
  { name: 'سلوى', price: 2 },
  { name: 'العدان', price: 2 },
  { name: 'الشعب', price: 2 },
  { name: 'هدية', price: 3 },
  { name: 'الصليبيخات', price: 3 },
  { name: 'الجهراء', price: 3 },
  { name: 'الفنطاس', price: 3 },
  { name: 'سعد العبدالله', price: 3 },
  { name: 'الفنيطيس', price: 3 },
  { name: 'الدوحة', price: 3 },
  { name: 'العقيلة', price: 3 },
  { name: 'جابر العلي', price: 3 },
  { name: 'جابر الاحمد', price: 3 },
  { name: 'عبدالله مبارك', price: 3 },
  { name: 'المهبولة', price: 3 },
  { name: 'المنقف', price: 3 },
  { name: 'الاحمدي', price: 3 },
  { name: 'الصليبية', price: 3 },
  { name: 'الصباحية', price: 3 },
  { name: 'فهد الاحمد', price: 3 },
  { name: 'صبحان', price: 3 },
  { name: 'ابو فطيرة', price: 3 },
  { name: 'ابو الحصانية', price: 3 },
  { name: 'الظهر', price: 3 },
  { name: 'ابو حليفة', price: 3 },
  { name: 'الفحيحيل', price: 3 },
  { name: 'جليب الشيوخ', price: 3 },
  { name: 'ام الهيمان', price: 4 },
  { name: 'المطلاع', price: 5 },
  { name: 'صباح الاحمد', price: 6 },
  { name: 'الوفرة', price: 8 }
];

// Helper Functions
function showToast(message) {
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

function generateId() {
  return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function generateInvoiceNumber() {
  const invoices = allRecords.filter(r => r.type === 'invoice');
  return 'INV-' + (invoices.length + 1).toString().padStart(6, '0');
}

function generateCashierCode() {
  return Math.floor(1000 + Math.random() * 9000).toString();
}

function convertToEnglishNumbers(str) {
  const arabicNumbers = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
  const englishNumbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
  
  for (let i = 0; i < arabicNumbers.length; i++) {
    str = str.replace(new RegExp(arabicNumbers[i], 'g'), englishNumbers[i]);
  }
  return str;
}

function getDeviceId() {
  if (!deviceId) {
    deviceId = localStorage.getItem('deviceId');
    if (!deviceId) {
      deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('deviceId', deviceId);
    }
  }
  return deviceId;
}

function getDeviceBranch() {
  if (!deviceBranch) {
    deviceBranch = localStorage.getItem('deviceBranch');
  }
  return deviceBranch;
}

function setDeviceBranch(branch) {
  deviceBranch = branch;
  localStorage.setItem('deviceBranch', branch);
}

// Load data from Firebase
async function loadFromFirebase() {
  try {
    const snapshot = await database.ref().once('value');
    const firebaseData = snapshot.val();
    
    if (firebaseData) {
      const allData = [];
      
      // Combine all types
      Object.keys(firebaseData).forEach(type => {
        if (firebaseData[type] && typeof firebaseData[type] === 'object') {
          Object.values(firebaseData[type]).forEach(item => {
            allData.push(item);
          });
        }
      });
      
      // Update local records
      if (allData.length > 0) {
        allRecords = allData;
      }
    }
  } catch (error) {
    console.error('Error loading from Firebase:', error);
  }
}

// Save to Firebase
async function saveToFirebase(record) {
  try {
    const recordId = record.id;
    await database.ref(`${record.type}s/${recordId}`).set(record);
    return true;
  } catch (error) {
    console.error('Error saving to Firebase:', error);
    return false;
  }
}

// Delete from Firebase
async function deleteFromFirebase(record) {
  try {
    const recordId = record.id;
    await database.ref(`${record.type}s/${recordId}`).remove();
    return true;
  } catch (error) {
    console.error('Error deleting from Firebase:', error);
    return false;
  }
}

// Initialize App
async function initApp() {
  await loadFromFirebase();
  render();
}

// Render Functions
function render() {
  const app = document.getElementById('app');
  
  if (currentScreen === 'home') {
    app.innerHTML = renderHome();
  } else if (currentScreen === 'accounting') {
    app.innerHTML = renderAccounting();
  } else if (currentScreen === 'cashier') {
    app.innerHTML = renderCashier();
  } else if (currentScreen === 'cashierLogin') {
    app.innerHTML = renderCashierLogin();
  } else if (currentScreen === 'newInvoice') {
    app.innerHTML = renderNewInvoice();
  } else if (currentScreen === 'selectCustomer') {
    app.innerHTML = renderSelectCustomer();
  }
  
  attachEventListeners();
}

function renderHome() {
  return `
    <div class="flex flex-col items-center justify-center min-h-full bg-gradient-to-br from-purple-50 to-blue-50 p-8">
      <div class="text-center mb-12">
        <div class="w-32 h-32 mx-auto mb-6 bg-gradient-to-br from-purple-600 to-blue-600 rounded-full flex items-center justify-center">
          <svg class="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
          </svg>
        </div>
        <h1 class="text-4xl font-bold text-gray-800 mb-2">مخبز التين والزيتون</h1>
        <p class="text-xl text-gray-600">مطعم التين الطبيعي</p>
      </div>
      
      <div class="flex flex-col gap-6 w-full max-w-md">
        <button onclick="showCashierLogin()" class="btn-primary text-white text-2xl font-bold py-6 px-12 rounded-xl shadow-lg">
          ${translate('cashier')}
        </button>
        
        <button onclick="showAccountingLogin()" class="btn-primary text-white text-2xl font-bold py-6 px-12 rounded-xl shadow-lg">
          ${translate('accounting')}
        </button>
      </div>
      
      <button onclick="toggleLanguage()" class="mt-12 px-6 py-3 bg-white text-gray-700 rounded-lg shadow hover:shadow-md transition">
        ${currentLang === 'ar' ? 'English' : 'عربي'}
      </button>
    </div>
  `;
}

function renderAccounting() {
  const dir = currentLang === 'ar' ? 'rtl' : 'ltr';
  
  return `
    <div class="flex h-full" dir="${dir}">
      <!-- Sidebar -->
      <div class="w-64 bg-white shadow-lg">
        <div class="p-6 border-b">
          <h2 class="text-xl font-bold text-gray-800">${translate('accounting')}</h2>
        </div>
        
        <nav class="p-4">
          <button onclick="changePage('orders')" class="sidebar-item ${currentPage === 'orders' ? 'active' : ''} w-full text-right px-4 py-3 rounded-lg mb-2">
            ${translate('orders')}
          </button>
          <button onclick="changePage('customers')" class="sidebar-item ${currentPage === 'customers' ? 'active' : ''} w-full text-right px-4 py-3 rounded-lg mb-2">
            ${translate('customers')}
          </button>
          <button onclick="changePage('products')" class="sidebar-item ${currentPage === 'products' ? 'active' : ''} w-full text-right px-4 py-3 rounded-lg mb-2">
            ${translate('products')}
          </button>
          <button onclick="changePage('categories')" class="sidebar-item ${currentPage === 'categories' ? 'active' : ''} w-full text-right px-4 py-3 rounded-lg mb-2">
            ${translate('categories')}
          </button>
          <button onclick="changePage('devices')" class="sidebar-item ${currentPage === 'devices' ? 'active' : ''} w-full text-right px-4 py-3 rounded-lg mb-2">
            ${translate('devices')}
          </button>
        </nav>
        
        <div class="absolute bottom-4 left-4 right-4">
          <button onclick="logout()" class="w-full px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600">
            ${translate('logout')}
          </button>
        </div>
      </div>
      
      <!-- Main Content -->
      <div class="flex-1 bg-gray-50 overflow-auto">
        ${renderPage()}
      </div>
    </div>
  `;
}

function renderPage() {
  if (currentPage === 'orders') return renderOrdersPage();
  if (currentPage === 'customers') return renderCustomersPage();
  if (currentPage === 'products') return renderProductsPage();
  if (currentPage === 'categories') return renderCategoriesPage();
  if (currentPage === 'devices') return renderDevicesPage();
  return '';
}

function renderOrdersPage() {
  const invoices = allRecords.filter(r => r.type === 'invoice' && !r.is_draft);
  
  return `
    <div class="p-8">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">${translate('orders')}</h1>
      </div>
      
      <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-6 py-4 text-right">${translate('invoiceNumber')}</th>
                <th class="px-6 py-4 text-right">${translate('customerName')}</th>
                <th class="px-6 py-4 text-right">${translate('date')}</th>
                <th class="px-6 py-4 text-right">${translate('total')}</th>
                <th class="px-6 py-4 text-right">${translate('branch')}</th>
                <th class="px-6 py-4 text-right">${translate('cashierName')}</th>
                <th class="px-6 py-4 text-center">الإجراءات</th>
              </tr>
            </thead>
            <tbody>
              ${invoices.map(inv => `
                <tr class="border-b hover:bg-gray-50">
                  <td class="px-6 py-4">${inv.invoice_number}</td>
                  <td class="px-6 py-4">${inv.customer_name}</td>
                  <td class="px-6 py-4">${new Date(inv.date).toLocaleDateString('ar-SA')}</td>
                  <td class="px-6 py-4">${inv.total} ${translate('kwd')}</td>
                  <td class="px-6 py-4">${inv.branch ? getBranchName(inv.branch) : '-'}</td>
                  <td class="px-6 py-4">${inv.cashier_name || '-'}</td>
                  <td class="px-6 py-4 text-center">
                    <button onclick="deleteInvoice('${inv.id}')" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                      ${translate('delete')}
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
}

function renderCustomersPage() {
  const customers = allRecords.filter(r => r.type === 'customer');
  
  return `
    <div class="p-8">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">${translate('customers')}</h1>
        <button onclick="showAddCustomerModal()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
          ${translate('addCustomer')}
        </button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        ${customers.map(customer => {
          const customerInvoices = allRecords.filter(r => r.type === 'invoice' && r.customer_phone === customer.customer_phone && !r.is_draft);
          return `
            <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition">
              <h3 class="text-xl font-bold text-gray-800 mb-2">${customer.customer_name}</h3>
              <p class="text-gray-600 mb-1">${customer.country_code}${customer.customer_phone}</p>
              <p class="text-sm text-gray-500 mb-4">${customer.area || ''}</p>
              <div class="flex items-center text-purple-600">
                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <span class="font-semibold">${customerInvoices.length} ${currentLang === 'ar' ? 'طلب' : 'orders'}</span>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
}

function renderProductsPage() {
  const products = allRecords.filter(r => r.type === 'product');
  
  return `
    <div class="p-8">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">${translate('products')}</h1>
        <button onclick="showAddProductModal()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
          ${translate('addProduct')}
        </button>
      </div>
      
      <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-6 py-4 text-right">${translate('productNameAr')}</th>
                <th class="px-6 py-4 text-right">${translate('productNameEn')}</th>
                <th class="px-6 py-4 text-right">${translate('salePrice')}</th>
                <th class="px-6 py-4 text-right">${translate('unit')}</th>
                <th class="px-6 py-4 text-right">${translate('quantity')}</th>
                <th class="px-6 py-4 text-center">الإجراءات</th>
              </tr>
            </thead>
            <tbody>
              ${products.map(product => `
                <tr class="border-b hover:bg-gray-50">
                  <td class="px-6 py-4">${product.name_ar}</td>
                  <td class="px-6 py-4">${product.name_en}</td>
                  <td class="px-6 py-4">${product.price} ${translate('kwd')}</td>
                  <td class="px-6 py-4">${product.unit}</td>
                  <td class="px-6 py-4">${product.quantity}</td>
                  <td class="px-6 py-4 text-center">
                    <button onclick="deleteProduct('${product.id}')" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                      ${translate('delete')}
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
}

function renderCategoriesPage() {
  const categories = allRecords.filter(r => r.type === 'category' && !r.parent_id);
  
  return `
    <div class="p-8">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">${translate('categories')}</h1>
        <button onclick="showAddCategoryModal()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
          ${translate('addCategory')}
        </button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        ${categories.map(category => {
          const productIds = category.product_ids ? category.product_ids.split(',').filter(id => id) : [];
          const subCategories = allRecords.filter(r => r.type === 'category' && r.parent_id === category.id);
          
          return `
            <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition">
              <div class="flex justify-between items-start mb-2">
                <h3 class="text-xl font-bold text-gray-800">${currentLang === 'ar' ? category.name_ar : category.name_en}</h3>
                <button onclick="showEditCategoryModal('${category.id}')" class="text-blue-600 hover:text-blue-800">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                </button>
              </div>
              <p class="text-gray-600 mb-1">${productIds.length} ${currentLang === 'ar' ? 'منتج' : 'products'}</p>
              <p class="text-gray-500 mb-3">${subCategories.length} ${currentLang === 'ar' ? 'قسم فرعي' : 'sub-categories'}</p>
              <div class="flex gap-2">
                <button onclick="manageProductsInCategory('${category.id}')" class="flex-1 px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200">
                  إدارة المنتجات
                </button>
                <button onclick="showAddSubCategoryModal('${category.id}')" class="flex-1 px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200">
                  قسم فرعي
                </button>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
}

function renderDevicesPage() {
  const devices = allRecords.filter(r => r.type === 'device');
  const cashiers = allRecords.filter(r => r.type === 'cashier');
  const currentDeviceId = getDeviceId();
  const currentDeviceBranch = getDeviceBranch();
  
  return `
    <div class="p-8">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">${translate('devices')}</h1>
      
      <!-- Current Device Info -->
      <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-8">
        <h2 class="text-xl font-bold text-blue-800 mb-3">الجهاز الحالي</h2>
        <p class="text-gray-700 mb-2"><strong>معرّف الجهاز:</strong> ${currentDeviceId}</p>
        <p class="text-gray-700 mb-4"><strong>الفرع:</strong> ${currentDeviceBranch ? getBranchName(currentDeviceBranch) : translate('deviceNotDefined')}</p>
        ${!currentDeviceBranch ? `
          <select id="currentDeviceBranch" class="w-full px-4 py-3 border rounded-lg mb-3">
            <option value="">${translate('selectBranch')}</option>
            <option value="main">${translate('mainBranch')}</option>
            <option value="abu_hasaniya">${translate('abuHasaniya')}</option>
            <option value="yarmouk">${translate('yarmouk')}</option>
          </select>
          <button onclick="setCurrentDeviceBranch()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            تعريف الجهاز
          </button>
        ` : `
          <button onclick="clearCurrentDeviceBranch()" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700">
            إلغاء تعريف الجهاز
          </button>
        `}
      </div>
      
      <!-- All Devices -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-xl font-bold text-gray-800 mb-4">جميع الأجهزة المسجلة</h2>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-6 py-4 text-right">معرّف الجهاز</th>
                <th class="px-6 py-4 text-right">الفرع</th>
                <th class="px-6 py-4 text-right">الحالة</th>
                <th class="px-6 py-4 text-center">الإجراءات</th>
              </tr>
            </thead>
            <tbody>
              ${devices.map(device => `
                <tr class="border-b hover:bg-gray-50">
                  <td class="px-6 py-4">${device.device_id}</td>
                  <td class="px-6 py-4">${device.branch ? getBranchName(device.branch) : '-'}</td>
                  <td class="px-6 py-4">
                    ${device.device_id === currentDeviceId ? 
                      '<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">متصل</span>' : 
                      '<span class="px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-sm">غير متصل</span>'}
                  </td>
                  <td class="px-6 py-4 text-center">
                    <button onclick="deleteDevice('${device.id}')" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                      ${translate('delete')}
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Cashiers -->
      <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-gray-800">الكاشيرات</h2>
          <button onclick="showAddCashierModal()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
            ${translate('addCashier')}
          </button>
        </div>
        
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-6 py-4 text-right">${translate('cashierName')}</th>
                <th class="px-6 py-4 text-right">${translate('cashierCode')}</th>
                <th class="px-6 py-4 text-center">الإجراءات</th>
              </tr>
            </thead>
            <tbody>
              ${cashiers.map(cashier => `
                <tr class="border-b hover:bg-gray-50">
                  <td class="px-6 py-4">${cashier.cashier_name}</td>
                  <td class="px-6 py-4">${cashier.cashier_code}</td>
                  <td class="px-6 py-4 text-center">
                    <button onclick="deleteCashier('${cashier.id}')" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                      ${translate('delete')}
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
}

function renderCashier() {
  const invoices = allRecords.filter(r => r.type === 'invoice' && !r.is_draft && r.branch === getDeviceBranch());
  const drafts = allRecords.filter(r => r.type === 'invoice' && r.is_draft === true && r.branch === getDeviceBranch());
  
  const branchName = getBranchName(getDeviceBranch());
  const cashierDisplay = currentCashier ? `${currentCashier.cashier_name} (${branchName})` : '';
  
  return `
    <div class="h-full bg-gray-50" dir="${currentLang === 'ar' ? 'rtl' : 'ltr'}">
      <div class="bg-white shadow-lg p-6 flex justify-between items-center">
        <div>
          <h1 class="text-2xl font-bold text-gray-800">${translate('cashier')}</h1>
          <p class="text-gray-600">${cashierDisplay}</p>
        </div>
        <div class="flex gap-4">
          <button onclick="showNewInvoice()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
            ${translate('newInvoice')}
          </button>
          <button onclick="logout()" class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600">
            ${translate('logout')}
          </button>
        </div>
      </div>
      
      ${drafts.length > 0 ? `
        <div class="p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">${translate('openInvoices')}</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            ${drafts.map(draft => `
              <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 cursor-pointer hover:shadow-lg transition" onclick="continueDraft('${draft.id}')">
                <p class="font-bold text-gray-800">${draft.customer_name || 'فاتورة جديدة'}</p>
                <p class="text-sm text-gray-600">${new Date(draft.date).toLocaleString('ar-SA')}</p>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
      
      <div class="p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">${translate('orders')}</h2>
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-6 py-4 text-right">${translate('invoiceNumber')}</th>
                  <th class="px-6 py-4 text-right">${translate('customerName')}</th>
                  <th class="px-6 py-4 text-right">${translate('date')}</th>
                  <th class="px-6 py-4 text-right">${translate('total')}</th>
                  <th class="px-6 py-4 text-center">الإجراءات</th>
                </tr>
              </thead>
              <tbody>
                ${invoices.map(inv => `
                  <tr class="border-b hover:bg-gray-50">
                    <td class="px-6 py-4">${inv.invoice_number}</td>
                    <td class="px-6 py-4">${inv.customer_name}</td>
                    <td class="px-6 py-4">${new Date(inv.date).toLocaleDateString('ar-SA')}</td>
                    <td class="px-6 py-4">${inv.total} ${translate('kwd')}</td>
                    <td class="px-6 py-4 text-center">
                      <button onclick="reprintInvoice('${inv.id}')" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        إعادة طباعة
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  `;
}

function renderCashierLogin() {
  return `
    <div class="flex items-center justify-center min-h-full bg-gradient-to-br from-purple-50 to-blue-50 p-8">
      <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
        <div class="text-center mb-8">
          <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-purple-600 to-blue-600 rounded-full flex items-center justify-center">
            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-gray-800">${translate('cashier')}</h2>
        </div>
        
        <div id="cashierLoginError" class="hidden mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg"></div>
        
        <div class="mb-6">
          <label class="block text-gray-700 mb-2">${translate('cashierCode')}</label>
          <input type="password" id="cashierCodeInput" class="number-input w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="****">
        </div>
        
        <div class="flex gap-4">
          <button onclick="loginCashier()" class="flex-1 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
            دخول
          </button>
          <button onclick="backToHome()" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
            ${translate('cancel')}
          </button>
        </div>
      </div>
    </div>
  `;
}

function renderNewInvoice() {
  const categories = allRecords.filter(r => r.type === 'category' && !r.parent_id);
  
  const total = selectedProducts.reduce((sum, item) => sum + (item.price * item.qty), 0);
  
  return `
    <div class="h-full flex" dir="${currentLang === 'ar' ? 'rtl' : 'ltr'}">
      <!-- Left Side - Products Selection -->
      <div class="flex-1 bg-gray-50 p-6 overflow-auto">
        <div class="mb-6">
          <input type="text" id="productSearch" oninput="searchProducts()" placeholder="${translate('search')}..." class="w-full px-4 py-3 border rounded-lg">
        </div>
        
        <div id="productsArea" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          ${categories.map(cat => `
            <div class="product-card bg-white rounded-lg shadow p-4" onclick="openCategory('${cat.id}')">
              <h3 class="font-bold text-gray-800">${currentLang === 'ar' ? cat.name_ar : cat.name_en}</h3>
              <p class="text-sm text-gray-500">${currentLang === 'ar' ? 'قسم' : 'Category'}</p>
            </div>
          `).join('')}
        </div>
      </div>
      
      <!-- Right Side - Invoice Items -->
      <div class="w-96 bg-white shadow-lg flex flex-col">
        <div class="p-6 border-b flex justify-between items-center">
          <h2 class="text-xl font-bold text-gray-800">${translate('newInvoice')}</h2>
          <button onclick="saveDraftAndClose()" class="text-2xl text-gray-500 hover:text-gray-700">×</button>
        </div>
        
        <div class="flex-1 overflow-auto p-6">
          ${selectedProducts.length === 0 ? `
            <div class="text-center text-gray-400 mt-12">
              <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
              </svg>
              <p>${currentLang === 'ar' ? 'لا توجد منتجات' : 'No products'}</p>
            </div>
          ` : selectedProducts.map((item, index) => `
            <div class="flex items-center justify-between mb-4 p-3 bg-gray-50 rounded-lg">
              <div class="flex-1">
                <p class="font-semibold text-gray-800">${currentLang === 'ar' ? item.name_ar : item.name_en}</p>
                <p class="text-sm text-gray-600">${item.price} ${translate('kwd')}</p>
              </div>
              <input type="text" value="${item.qty}" onchange="updateQuantity(${index}, this.value)" class="number-input w-20 px-2 py-1 border rounded text-center mx-2">
              <button onclick="removeProduct(${index})" class="text-red-500 hover:text-red-700">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            </div>
          `).join('')}
        </div>
        
        <div class="p-6 border-t">
          <div class="flex justify-between items-center mb-4">
            <span class="text-xl font-bold text-gray-800">${translate('total')}</span>
            <span class="text-2xl font-bold text-purple-600">${total.toFixed(3)} ${translate('kwd')}</span>
          </div>
          
          <button onclick="proceedToCustomer()" ${selectedProducts.length === 0 ? 'disabled' : ''} class="w-full px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
            ${translate('next')}
          </button>
        </div>
      </div>
    </div>
  `;
}

function renderSelectCustomer() {
  return `
    <div class="h-full bg-gray-50 p-8" dir="${currentLang === 'ar' ? 'rtl' : 'ltr'}">
      <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg p-8">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">اختر نوع الطلب</h2>
            <button onclick="backToNewInvoice()" class="text-2xl text-gray-500 hover:text-gray-700">×</button>
          </div>
          
          <div class="grid grid-cols-2 gap-6 mb-8">
            <button onclick="selectDeliveryType('delivery')" class="p-8 bg-gradient-to-br from-purple-500 to-blue-500 text-white rounded-xl hover:shadow-xl transition">
              <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"></path>
              </svg>
              <span class="text-2xl font-bold">${translate('delivery')}</span>
            </button>
            
            <button onclick="selectDeliveryType('pickup')" class="p-8 bg-gradient-to-br from-green-500 to-teal-500 text-white rounded-xl hover:shadow-xl transition">
              <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
              </svg>
              <span class="text-2xl font-bold">${translate('pickup')}</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
}

function getBranchName(branch) {
  const branches = {
    main: currentLang === 'ar' ? 'الفرع الرئيسي' : 'Main Branch',
    abu_hasaniya: currentLang === 'ar' ? 'أبو الحصانية' : 'Abu Hasaniya',
    yarmouk: currentLang === 'ar' ? 'اليرموك' : 'Yarmouk'
  };
  return branches[branch] || branch;
}

// Event Handlers
function attachEventListeners() {
  // Auto-convert Arabic numbers to English
  document.querySelectorAll('.number-input').forEach(input => {
    input.addEventListener('input', function(e) {
      this.value = convertToEnglishNumbers(this.value);
    });
  });
}

// Navigation Functions
function toggleLanguage() {
  currentLang = currentLang === 'ar' ? 'en' : 'ar';
  document.documentElement.lang = currentLang;
  document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
  render();
}

function showAccountingLogin() {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-xl shadow-2xl p-8">
      <h3 class="text-xl font-bold mb-4">إدخال كلمة المرور</h3>
      <input type="password" id="adminPassword" class="w-full px-4 py-3 border rounded-lg mb-4" placeholder="كلمة المرور">
      <div class="flex gap-4">
        <button onclick="checkAdminPassword()" class="flex-1 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
          دخول
        </button>
        <button onclick="closeModal()" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
          إلغاء
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function checkAdminPassword() {
  const password = document.getElementById('adminPassword').value;
  if (password === '5466') {
    closeModal();
    currentScreen = 'accounting';
    currentPage = 'orders';
    render();
  } else {
    showToast('كلمة المرور غير صحيحة');
  }
}

function showCashierLogin() {
  const branch = getDeviceBranch();
  if (!branch) {
    showToast('يجب تعريف الجهاز أولاً من لوحة الإدارة');
    return;
  }
  currentScreen = 'cashierLogin';
  render();
}

function loginCashier() {
  const code = document.getElementById('cashierCodeInput').value;
  const cashier = allRecords.find(r => r.type === 'cashier' && r.cashier_code === code);
  
  const errorDiv = document.getElementById('cashierLoginError');
  
  if (cashier) {
    currentCashier = cashier;
    currentScreen = 'cashier';
    render();
  } else {
    errorDiv.textContent = 'رمز الكاشير غير صحيح';
    errorDiv.classList.remove('hidden');
  }
}

function logout() {
  currentScreen = 'home';
  currentCashier = null;
  render();
}

function backToHome() {
  currentScreen = 'home';
  render();
}

function changePage(page) {
  currentPage = page;
  render();
}

function showNewInvoice() {
  selectedProducts = [];
  currentInvoice = null;
  currentScreen = 'newInvoice';
  render();
}

function backToNewInvoice() {
  currentScreen = 'newInvoice';
  render();
}

function proceedToCustomer() {
  if (selectedProducts.length === 0) return;
  currentScreen = 'selectCustomer';
  render();
}

function selectDeliveryType(type) {
  if (type === 'delivery') {
    showCustomerSelectionModal();
  } else {
    showPickupModal();
  }
}

// Modal Functions
function showAddProductModal() {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-2xl" dir="${currentLang === 'ar' ? 'rtl' : 'ltr'}">
      <h3 class="text-2xl font-bold text-gray-800 mb-6">${translate('addProduct')}</h3>
      
      <div class="space-y-4">
        <div>
          <label class="block text-gray-700 mb-2">${translate('productNameAr')}</label>
          <input type="text" id="productNameAr" class="w-full px-4 py-3 border rounded-lg">
        </div>
        
        <div>
          <label class="block text-gray-700 mb-2">${translate('productNameEn')}</label>
          <input type="text" id="productNameEn" class="w-full px-4 py-3 border rounded-lg">
        </div>
        
        <div>
          <label class="block text-gray-700 mb-2">${translate('salePrice')}</label>
          <input type="text" id="productPrice" class="number-input w-full px-4 py-3 border rounded-lg">
        </div>
        
        <div>
          <label class="block text-gray-700 mb-2">${translate('unit')}</label>
          <select id="productUnit" class="w-full px-4 py-3 border rounded-lg">
            ${units.map(unit => `<option value="${unit}">${unit}</option>`).join('')}
          </select>
        </div>
        
        <div>
          <label class="block text-gray-700 mb-2">${translate('quantity')}</label>
          <input type="text" id="productQuantity" class="number-input w-full px-4 py-3 border rounded-lg">
        </div>
      </div>
      
      <div class="flex gap-4 mt-6">
        <button onclick="saveProduct()" class="flex-1 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
          ${translate('add')}
        </button>
        <button onclick="closeModal()" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
          ${translate('cancel')}
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  attachEventListeners();
}

async function saveProduct() {
  const nameAr = document.getElementById('productNameAr').value;
  const nameEn = document.getElementById('productNameEn').value;
  const price = parseFloat(convertToEnglishNumbers(document.getElementById('productPrice').value));
  const unit = document.getElementById('productUnit').value;
  const quantity = parseFloat(convertToEnglishNumbers(document.getElementById('productQuantity').value));
  
  if (!nameAr || !nameEn || !price || !quantity) {
    showToast('يرجى ملء جميع الحقول');
    return;
  }
  
  const product = {
    type: 'product',
    id: generateId(),
    name_ar: nameAr,
    name_en: nameEn,
    price: price,
    unit: unit,
    quantity: quantity
  };
  
  const saved = await saveToFirebase(product);
  
  if (saved) {
    allRecords.push(product);
    closeModal();
    render();
    showToast('تم إضافة المنتج بنجاح');
  } else {
    showToast('حدث خطأ أثناء إضافة المنتج');
  }
}

function showAddCategoryModal() {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-2xl" dir="${currentLang === 'ar' ? 'rtl' : 'ltr'}">
      <h3 class="text-2xl font-bold text-gray-800 mb-6">${translate('addCategory')}</h3>
      
      <div class="space-y-4">
        <div>
          <label class="block text-gray-700 mb-2">${translate('categoryNameAr')}</label>
          <input type="text" id="categoryNameAr" class="w-full px-4 py-3 border rounded-lg">
        </div>
        
        <div>
          <label class="block text-gray-700 mb-2">${translate('categoryNameEn')}</label>
          <input type="text" id="categoryNameEn" class="w-full px-4 py-3 border rounded-lg">
        </div>
      </div>
      
      <div class="flex gap-4 mt-6">
        <button onclick="saveCategory()" class="flex-1 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
          ${translate('add')}
        </button>
        <button onclick="closeModal()" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
          ${translate('cancel')}
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

async function saveCategory() {
  const nameAr = document.getElementById('categoryNameAr').value;
  const nameEn = document.getElementById('categoryNameEn').value;
  
  if (!nameAr || !nameEn) {
    showToast('يرجى ملء جميع الحقول');
    return;
  }
  
  const category = {
    type: 'category',
    id: generateId(),
    name_ar: nameAr,
    name_en: nameEn,
    product_ids: '',
    parent_id: ''
  };
  
  const saved = await saveToFirebase(category);
  
  if (saved) {
    allRecords.push(category);
    closeModal();
    render();
    showToast('تم إضافة القسم بنجاح');
  } else {
    showToast('حدث خطأ أثناء إضافة القسم');
  }
}

function showAddSubCategoryModal(parentId) {
  const parent = allRecords.find(r => r.id === parentId);
  if (!parent) return;
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-2xl" dir="${currentLang === 'ar' ? 'rtl' : 'ltr'}">
      <h3 class="text-2xl font-bold text-gray-800 mb-6">${translate('addSubCategory')} - ${currentLang === 'ar' ? parent.name_ar : parent.name_en}</h3>
      
      <div class="space-y-4">
        <div>
          <label class="block text-gray-700 mb-2">${translate('categoryNameAr')}</label>
          <input type="text" id="subCategoryNameAr" class="w-full px-4 py-3 border rounded-lg">
        </div>
        
        <div>
          <label class="block text-gray-700 mb-2">${translate('categoryNameEn')}</label>
          <input type="text" id="subCategoryNameEn" class="w-full px-4 py-3 border rounded-lg">
        </div>
      </div>
      
      <div class="flex gap-4 mt-6">
        <button onclick="saveSubCategory('${parentId}')" class="flex-1 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
          ${translate('add')}
        </button>
        <button onclick="closeModal()" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
          ${translate('cancel')}
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

async function saveSubCategory(parentId) {
  const nameAr = document.getElementById('subCategoryNameAr').value;
  const nameEn = document.getElementById('subCategoryNameEn').value;
  
  if (!nameAr || !nameEn) {
    showToast('يرجى ملء جميع الحقول');
    return;
  }
  
  const subCategory = {
    type: 'category',
    id: generateId(),
    name_ar: nameAr,
    name_en: nameEn,
    product_ids: '',
    parent_id: parentId
  };
  
  const saved = await saveToFirebase(subCategory);
  
  if (saved) {
    allRecords.push(subCategory);
    closeModal();
    render();
    showToast('تم إضافة القسم الفرعي بنجاح');
  } else {
    showToast('حدث خطأ أثناء إضافة القسم الفرعي');
  }
}

function showAddCustomerModal() {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-2xl" dir="${currentLang === 'ar' ? 'rtl' : 'ltr'}">
      <h3 class="text-2xl font-bold text-gray-800 mb-6">${translate('addCustomer')}</h3>
      
      <div class="space-y-4">
        <div>
          <label class="block text-gray-700 mb-2">${translate('customerName')}</label>
          <input type="text" id="customerName" class="w-full px-4 py-3 border rounded-lg">
        </div>
        
        <div class="grid grid-cols-3 gap-4">
          <div>
            <label class="block text-gray-700 mb-2">${translate('countryCode')}</label>
            <input type="text" id="countryCode" value="965" class="number-input w-full px-4 py-3 border rounded-lg">
          </div>
          <div class="col-span-2">
            <label class="block text-gray-700 mb-2">${translate('phoneNumber')}</label>
            <input type="text" id="customerPhone" class="number-input w-full px-4 py-3 border rounded-lg">
          </div>
        </div>
        
        <div>
          <label class="block text-gray-700 mb-2">${translate('area')}</label>
          <select id="customerArea" class="w-full px-4 py-3 border rounded-lg">
            <option value="">اختر المنطقة</option>
            ${areas.map(area => `<option value="${area.name}">${area.name} - ${area.price} د.ك</option>`).join('')}
          </select>
        </div>
        
        <div>
          <label class="block text-gray-700 mb-2">${translate('addressDetail')}</label>
          <textarea id="customerAddress" class="w-full px-4 py-3 border rounded-lg" rows="3"></textarea>
        </div>
      </div>
      
      <div class="flex gap-4 mt-6">
        <button onclick="saveCustomer()" class="flex-1 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
          ${translate('add')}
        </button>
        <button onclick="closeModal()" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
          ${translate('cancel')}
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  attachEventListeners();
}

async function saveCustomer() {
  const name = document.getElementById('customerName').value;
  const countryCode = convertToEnglishNumbers(document.getElementById('countryCode').value);
  const phone = convertToEnglishNumbers(document.getElementById('customerPhone').value);
  const area = document.getElementById('customerArea').value;
  const address = document.getElementById('customerAddress').value;
  
  if (!name || !phone) {
    showToast('يرجى ملء الحقول المطلوبة');
    return;
  }
  
  const customer = {
    type: 'customer',
    id: generateId(),
    customer_name: name,
    customer_phone: phone,
    country_code: countryCode,
    area: area,
    address_detail: address
  };
  
  const saved = await saveToFirebase(customer);
  
  if (saved) {
    allRecords.push(customer);
    closeModal();
    render();
    showToast('تم إضافة العميل بنجاح');
  } else {
    showToast('حدث خطأ أثناء إضافة العميل');
  }
}

function showAddCashierModal() {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-2xl" dir="${currentLang === 'ar' ? 'rtl' : 'ltr'}">
      <h3 class="text-2xl font-bold text-gray-800 mb-6">${translate('addCashier')}</h3>
      
      <div class="space-y-4">
        <div>
          <label class="block text-gray-700 mb-2">${translate('cashierName')}</label>
          <input type="text" id="cashierName" class="w-full px-4 py-3 border rounded-lg">
        </div>
        
        <div class="flex gap-4">
          <div class="flex-1">
            <label class="block text-gray-700 mb-2">${translate('cashierCode')}</label>
            <input type="text" id="cashierCode" class="number-input w-full px-4 py-3 border rounded-lg">
          </div>
          <div class="flex items-end">
            <button onclick="generateCashierCodeBtn()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
              ${translate('generate')}
            </button>
          </div>
        </div>
      </div>
      
      <div class="flex gap-4 mt-6">
        <button onclick="saveCashier()" class="flex-1 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
          ${translate('add')}
        </button>
        <button onclick="closeModal()" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
          ${translate('cancel')}
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  attachEventListeners();
}

function generateCashierCodeBtn() {
  document.getElementById('cashierCode').value = generateCashierCode();
}

async function saveCashier() {
  const name = document.getElementById('cashierName').value;
  const code = convertToEnglishNumbers(document.getElementById('cashierCode').value);
  
  if (!name || !code) {
    showToast('يرجى ملء جميع الحقول');
    return;
  }
  
  const cashier = {
    type: 'cashier',
    id: generateId(),
    cashier_name: name,
    cashier_code: code
  };
  
  const saved = await saveToFirebase(cashier);
  
  if (saved) {
    allRecords.push(cashier);
    closeModal();
    render();
    showToast('تم إضافة الكاشير بنجاح');
  } else {
    showToast('حدث خطأ أثناء إضافة الكاشير');
  }
}

function showCustomerSelectionModal() {
  const customers = allRecords.filter(r => r.type === 'customer');
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-4xl max-h-[80vh] overflow-auto" dir="${currentLang === 'ar' ? 'rtl' : 'ltr'}">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold text-gray-800">اختر العميل</h3>
        <button onclick="showAddCustomerModalInline()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
          ${translate('addCustomer')}
        </button>
      </div>
      
      <div class="mb-6">
        <input type="text" id="customerSearchInput" oninput="filterCustomers()" placeholder="${translate('search')}..." class="w-full px-4 py-3 border rounded-lg">
      </div>
      
      <div id="customersList" class="space-y-3">
        ${customers.map(customer => `
          <div class="customer-item p-4 border rounded-lg hover:bg-purple-50 cursor-pointer" onclick="selectCustomer('${customer.id}')">
            <h4 class="font-bold text-gray-800">${customer.customer_name}</h4>
            <p class="text-gray-600">${customer.country_code}${customer.customer_phone}</p>
            <p class="text-sm text-gray-500">${customer.area || ''} - ${customer.address_detail || ''}</p>
          </div>
        `).join('')}
      </div>
      
      <div class="mt-6">
        <button onclick="closeModal()" class="w-full px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
          ${translate('cancel')}
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function filterCustomers() {
  const search = document.getElementById('customerSearchInput').value.toLowerCase();
  const items = document.querySelectorAll('.customer-item');
  
  items.forEach(item => {
    const text = item.textContent.toLowerCase();
    item.style.display = text.includes(search) ? 'block' : 'none';
  });
}

async function selectCustomer(customerId) {
  const customer = allRecords.find(r => r.id === customerId);
  if (!customer) return;
  
  const deliveryPrice = areas.find(a => a.name === customer.area)?.price || 0;
  const subtotal = selectedProducts.reduce((sum, item) => sum + (item.price * item.qty), 0);
  const total = subtotal + deliveryPrice;
  
  await finalizeInvoice({
    customer_name: customer.customer_name,
    customer_phone: customer.customer_phone,
    country_code: customer.country_code,
    area: customer.area,
    address_detail: customer.address_detail,
    delivery_type: 'delivery',
    total: total
  });
}

function showPickupModal() {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-2xl" dir="${currentLang === 'ar' ? 'rtl' : 'ltr'}">
      <h3 class="text-2xl font-bold text-gray-800 mb-6">معلومات الاستلام</h3>
      
      <div class="space-y-4">
        <div>
          <label class="block text-gray-700 mb-2">${translate('customerName')}</label>
          <input type="text" id="pickupName" class="w-full px-4 py-3 border rounded-lg">
        </div>
        
        <div class="grid grid-cols-3 gap-4">
          <div>
            <label class="block text-gray-700 mb-2">${translate('countryCode')}</label>
            <input type="text" id="pickupCountryCode" value="965" class="number-input w-full px-4 py-3 border rounded-lg">
          </div>
          <div class="col-span-2">
            <label class="block text-gray-700 mb-2">${translate('phoneNumber')}</label>
            <input type="text" id="pickupPhone" class="number-input w-full px-4 py-3 border rounded-lg">
          </div>
        </div>
      </div>
      
      <div class="flex gap-4 mt-6">
        <button onclick="completePickup()" class="flex-1 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
          ${translate('print')}
        </button>
        <button onclick="closeModal()" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
          ${translate('cancel')}
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  attachEventListeners();
}

async function completePickup() {
  const name = document.getElementById('pickupName').value;
  const countryCode = convertToEnglishNumbers(document.getElementById('pickupCountryCode').value);
  const phone = convertToEnglishNumbers(document.getElementById('pickupPhone').value);
  
  if (!name || !phone) {
    showToast('يرجى ملء جميع الحقول');
    return;
  }
  
  const total = selectedProducts.reduce((sum, item) => sum + (item.price * item.qty), 0);
  
  await finalizeInvoice({
    customer_name: name,
    customer_phone: phone,
    country_code: countryCode,
    delivery_type: 'pickup',
    total: total,
    area: '',
    address_detail: ''
  });
}

async function finalizeInvoice(customerData) {
  const invoice = {
    type: 'invoice',
    id: generateId(),
    invoice_number: generateInvoiceNumber(),
    date: new Date().toISOString(),
    customer_name: customerData.customer_name,
    customer_phone: customerData.customer_phone,
    country_code: customerData.country_code,
    area: customerData.area || '',
    address_detail: customerData.address_detail || '',
    delivery_type: customerData.delivery_type,
    items: JSON.stringify(selectedProducts),
    total: customerData.total,
    branch: getDeviceBranch(),
    cashier_name: currentCashier?.cashier_name || '',
    is_draft: false,
    status: 'completed'
  };
  
  const saved = await saveToFirebase(invoice);
  
  if (saved) {
    allRecords.push(invoice);
    printInvoice(invoice);
    closeModal();
    selectedProducts = [];
    currentScreen = 'cashier';
    render();
    showToast('تم حفظ الفاتورة بنجاح');
  } else {
    showToast('حدث خطأ أثناء حفظ الفاتورة');
  }
}

function printInvoice(invoice) {
  const items = JSON.parse(invoice.items);
  const deliveryPrice = invoice.delivery_type === 'delivery' ? (areas.find(a => a.name === invoice.area)?.price || 0) : 0;
  const subtotal = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
  
  const printWindow = window.open('', '_blank', 'noopener,noreferrer');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html dir="rtl">
    <head>
      <meta charset="UTF-8">
      <style>
        @page { size: 80mm auto; margin: 0; }
        body { 
          width: 80mm; 
          margin: 0; 
          padding: 10mm; 
          font-family: Arial, sans-serif;
          font-size: 12px;
        }
        .header { text-align: center; margin-bottom: 10px; border-bottom: 2px dashed #000; padding-bottom: 10px; }
        .header h1 { margin: 5px 0; font-size: 16px; }
        .header p { margin: 2px 0; font-size: 10px; }
        .section { margin: 10px 0; }
        .item { display: flex; justify-content: space-between; margin: 5px 0; }
        .total { border-top: 2px solid #000; margin-top: 10px; padding-top: 10px; font-weight: bold; font-size: 14px; }
        .footer { text-align: center; margin-top: 10px; border-top: 2px dashed #000; padding-top: 10px; font-size: 10px; }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>مخبز التين والزيتون</h1>
        <p>الكويت، اليرموك ق٢ شارع ٢ بالقرب من باب فرع الجمعية</p>
        <p>☎️ 22085889 | 📱 65162277</p>
        <p>@figsolives.kw</p>
        <hr style="margin: 10px 0;">
        <h1>مطعم التين الطبيعي</h1>
        <p>الكويت، أبو الحصانية، مول ٣٠، المطل على شارع الفحيحيل السريع</p>
        <p>☎️ 22085886 | 📱 99176512</p>
        <p>@natural_figs</p>
      </div>
      
      <div class="section">
        <strong>رقم الفاتورة:</strong> ${invoice.invoice_number}<br>
        <strong>التاريخ:</strong> ${new Date(invoice.date).toLocaleString('ar-SA')}<br>
        <strong>العميل:</strong> ${invoice.customer_name}<br>
        <strong>الهاتف:</strong> ${invoice.country_code}${invoice.customer_phone}<br>
        ${invoice.delivery_type === 'delivery' ? `
          <strong>المنطقة:</strong> ${invoice.area}<br>
          <strong>العنوان:</strong> ${invoice.address_detail}<br>
        ` : '<strong>النوع:</strong> استلام<br>'}
      </div>
      
      <div class="section">
        <strong>المنتجات:</strong>
        ${items.map(item => `
          <div class="item">
            <span>${currentLang === 'ar' ? item.name_ar : item.name_en} × ${item.qty}</span>
            <span>${(item.price * item.qty).toFixed(3)} د.ك</span>
          </div>
        `).join('')}
      </div>
      
      <div class="total">
        <div class="item">
          <span>المجموع الفرعي:</span>
          <span>${subtotal.toFixed(3)} د.ك</span>
        </div>
        ${deliveryPrice > 0 ? `
          <div class="item">
            <span>رسوم التوصيل:</span>
            <span>${deliveryPrice.toFixed(3)} د.ك</span>
          </div>
        ` : ''}
        <div class="item" style="font-size: 16px;">
          <span>الإجمالي:</span>
          <span>${invoice.total.toFixed(3)} د.ك</span>
        </div>
      </div>
      
      <div class="footer">
        <p>الكاشير: ${invoice.cashier_name} | الفرع: ${getBranchName(invoice.branch)}</p>
        <p>شكراً لزيارتكم</p>
      </div>
    </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.print();
}

async function saveDraftAndClose() {
  if (selectedProducts.length === 0) {
    currentScreen = 'cashier';
    render();
    return;
  }
  
  const draft = {
    type: 'invoice',
    id: generateId(),
    invoice_number: '',
    date: new Date().toISOString(),
    customer_name: '',
    customer_phone: '',
    country_code: '965',
    area: '',
    address_detail: '',
    delivery_type: '',
    items: JSON.stringify(selectedProducts),
    total: 0,
    branch: getDeviceBranch(),
    cashier_name: currentCashier?.cashier_name || '',
    is_draft: true,
    status: 'draft'
  };
  
  const saved = await saveToFirebase(draft);
  
  if (saved) {
    allRecords.push(draft);
    selectedProducts = [];
    currentScreen = 'cashier';
    render();
  }
}

function continueDraft(draftId) {
  const draft = allRecords.find(r => r.id === draftId);
  if (!draft) return;
  
  selectedProducts = JSON.parse(draft.items);
  currentInvoice = draft;
  currentScreen = 'newInvoice';
  render();
}

function addProductToInvoice(productId) {
  const product = allRecords.find(r => r.id === productId);
  if (!product) return;
  
  const existing = selectedProducts.find(p => p.id === product.id);
  if (existing) {
    existing.qty += 1;
  } else {
    selectedProducts.push({
      id: product.id,
      name_ar: product.name_ar,
      name_en: product.name_en,
      price: product.price,
      qty: 1
    });
  }
  
  render();
}

function updateQuantity(index, value) {
  const qty = parseFloat(convertToEnglishNumbers(value));
  if (qty > 0) {
    selectedProducts[index].qty = qty;
    render();
  }
}

function removeProduct(index) {
  selectedProducts.splice(index, 1);
  render();
}

function searchProducts() {
  const search = document.getElementById('productSearch').value.toLowerCase();
  const products = allRecords.filter(r => r.type === 'product');
  const categories = allRecords.filter(r => r.type === 'category' && !r.parent_id);
  
  const productsArea = document.getElementById('productsArea');
  
  if (!search) {
    productsArea.innerHTML = categories.map(cat => `
      <div class="product-card bg-white rounded-lg shadow p-4" onclick="openCategory('${cat.id}')">
        <h3 class="font-bold text-gray-800">${currentLang === 'ar' ? cat.name_ar : cat.name_en}</h3>
        <p class="text-sm text-gray-500">${currentLang === 'ar' ? 'قسم' : 'Category'}</p>
      </div>
    `).join('');
    return;
  }
  
  const filtered = products.filter(p => 
    p.name_ar.toLowerCase().includes(search) || 
    p.name_en.toLowerCase().includes(search)
  );
  
  productsArea.innerHTML = filtered.map(product => `
    <div class="product-card bg-white rounded-lg shadow p-4" onclick="addProductToInvoice('${product.id}')">
      <h3 class="font-bold text-gray-800">${currentLang === 'ar' ? product.name_ar : product.name_en}</h3>
      <p class="text-sm text-gray-600">${product.price} ${translate('kwd')}</p>
    </div>
  `).join('');
}

function openCategory(categoryId) {
  const category = allRecords.find(r => r.id === categoryId);
  if (!category) return;
  
  const productIds = category.product_ids ? category.product_ids.split(',') : [];
  const products = allRecords.filter(r => r.type === 'product' && productIds.includes(r.id));
  const subCategories = allRecords.filter(r => r.type === 'category' && r.parent_id === category.id);
  
  const productsArea = document.getElementById('productsArea');
  productsArea.innerHTML = `
    <div class="col-span-full mb-4">
      <button onclick="showNewInvoice()" class="text-blue-600 hover:underline">← ${currentLang === 'ar' ? 'رجوع' : 'Back'}</button>
      <h2 class="text-2xl font-bold text-gray-800 mt-2">${currentLang === 'ar' ? category.name_ar : category.name_en}</h2>
    </div>
    ${subCategories.map(sub => `
      <div class="product-card bg-purple-100 rounded-lg shadow p-4" onclick="openCategory('${sub.id}')">
        <h3 class="font-bold text-gray-800">${currentLang === 'ar' ? sub.name_ar : sub.name_en}</h3>
        <p class="text-sm text-gray-500">${currentLang === 'ar' ? 'قسم فرعي' : 'Sub-Category'}</p>
      </div>
    `).join('')}
    ${products.map(product => `
      <div class="product-card bg-white rounded-lg shadow p-4" onclick="addProductToInvoice('${product.id}')">
        <h3 class="font-bold text-gray-800">${currentLang === 'ar' ? product.name_ar : product.name_en}</h3>
        <p class="text-sm text-gray-600">${product.price} ${translate('kwd')}</p>
      </div>
    `).join('')}
  `;
}

function setCurrentDeviceBranch() {
  const branch = document.getElementById('currentDeviceBranch').value;
  if (!branch) {
    showToast('يرجى اختيار الفرع');
    return;
  }
  
  setDeviceBranch(branch);
  saveDeviceRecord();
  render();
  showToast('تم تعريف الجهاز بنجاح');
}

function clearCurrentDeviceBranch() {
  localStorage.removeItem('deviceBranch');
  deviceBranch = null;
  render();
  showToast('تم إلغاء تعريف الجهاز');
}

async function saveDeviceRecord() {
  const existingDevice = allRecords.find(r => r.type === 'device' && r.device_id === getDeviceId());
  
  if (existingDevice) {
    const updated = { ...existingDevice, branch: getDeviceBranch() };
    await saveToFirebase(updated);
    const index = allRecords.findIndex(r => r.id === existingDevice.id);
    if (index !== -1) allRecords[index] = updated;
  } else {
    const deviceData = {
      type: 'device',
      id: generateId(),
      device_id: getDeviceId(),
      branch: getDeviceBranch()
    };
    
    await saveToFirebase(deviceData);
    allRecords.push(deviceData);
  }
}

async function deleteDevice(deviceId) {
  const device = allRecords.find(r => r.id === deviceId);
  if (!device) return;
  
  const confirmDiv = document.createElement('div');
  confirmDiv.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-50';
  confirmDiv.innerHTML = `
    <div class="bg-white rounded-xl shadow-2xl p-8">
      <p class="text-xl mb-6">هل أنت متأكد من حذف هذا الجهاز؟</p>
      <div class="flex gap-4">
        <button onclick="confirmDeleteDevice('${deviceId}')" class="flex-1 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700">
          نعم، احذف
        </button>
        <button onclick="closeModal()" class="flex-1 px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
          إلغاء
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(confirmDiv);
}

async function confirmDeleteDevice(deviceId) {
  const device = allRecords.find(r => r.id === deviceId);
  if (!device) return;
  
  await deleteFromFirebase(device);
  allRecords = allRecords.filter(r => r.id !== deviceId);
  
  closeModal();
  render();
  showToast('تم حذف الجهاز بنجاح');
}

async function deleteCashier(cashierId) {
  const cashier = allRecords.find(r => r.id === cashierId);
  if (!cashier) return;
  
  const confirmDiv = document.createElement('div');
  confirmDiv.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-50';
  confirmDiv.innerHTML = `
    <div class="bg-white rounded-xl shadow-2xl p-8">
      <p class="text-xl mb-6">هل أنت متأكد من حذف هذا الكاشير؟</p>
      <div class="flex gap-4">
        <button onclick="confirmDeleteCashier('${cashierId}')" class="flex-1 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700">
          نعم، احذف
        </button>
        <button onclick="closeModal()" class="flex-1 px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
          إلغاء
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(confirmDiv);
}

async function confirmDeleteCashier(cashierId) {
  const cashier = allRecords.find(r => r.id === cashierId);
  if (!cashier) return;
  
  await deleteFromFirebase(cashier);
  allRecords = allRecords.filter(r => r.id !== cashierId);
  
  closeModal();
  render();
  showToast('تم حذف الكاشير بنجاح');
}

async function deleteProduct(productId) {
  const product = allRecords.find(r => r.id === productId);
  if (!product) return;
  
  await deleteFromFirebase(product);
  allRecords = allRecords.filter(r => r.id !== productId);
  
  render();
  showToast('تم حذف المنتج بنجاح');
}

async function deleteInvoice(invoiceId) {
  const invoice = allRecords.find(r => r.id === invoiceId);
  if (!invoice) return;
  
  await deleteFromFirebase(invoice);
  allRecords = allRecords.filter(r => r.id !== invoiceId);
  
  render();
  showToast('تم حذف الفاتورة بنجاح');
}

function reprintInvoice(invoiceId) {
  const invoice = allRecords.find(r => r.id === invoiceId);
  if (invoice) {
    printInvoice(invoice);
  }
}

function showAddCustomerModalInline() {
  closeModal();
  showAddCustomerModal();
}

function closeModal() {
  const modals = document.querySelectorAll('.modal-overlay');
  modals.forEach(modal => modal.remove());
}

function showEditCategoryModal(categoryId) {
  const category = allRecords.find(r => r.id === categoryId);
  if (!category) return;
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-2xl" dir="${currentLang === 'ar' ? 'rtl' : 'ltr'}">
      <h3 class="text-2xl font-bold text-gray-800 mb-6">تعديل القسم</h3>
      
      <div class="space-y-4">
        <div>
          <label class="block text-gray-700 mb-2">${translate('categoryNameAr')}</label>
          <input type="text" id="editCategoryNameAr" value="${category.name_ar}" class="w-full px-4 py-3 border rounded-lg">
        </div>
        
        <div>
          <label class="block text-gray-700 mb-2">${translate('categoryNameEn')}</label>
          <input type="text" id="editCategoryNameEn" value="${category.name_en}" class="w-full px-4 py-3 border rounded-lg">
        </div>
      </div>
      
      <div class="flex gap-4 mt-6">
        <button onclick="updateCategory('${categoryId}')" class="flex-1 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
          ${translate('save')}
        </button>
        <button onclick="closeModal()" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
          ${translate('cancel')}
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

async function updateCategory(categoryId) {
  const category = allRecords.find(r => r.id === categoryId);
  if (!category) return;
  
  const nameAr = document.getElementById('editCategoryNameAr').value;
  const nameEn = document.getElementById('editCategoryNameEn').value;
  
  if (!nameAr || !nameEn) {
    showToast('يرجى ملء جميع الحقول');
    return;
  }
  
  const updated = {
    ...category,
    name_ar: nameAr,
    name_en: nameEn
  };
  
  const saved = await saveToFirebase(updated);
  
  if (saved) {
    const index = allRecords.findIndex(r => r.id === categoryId);
    if (index !== -1) allRecords[index] = updated;
    
    closeModal();
    render();
    showToast('تم تحديث القسم بنجاح');
  } else {
    showToast('حدث خطأ أثناء التحديث');
  }
}

function manageProductsInCategory(categoryId) {
  const category = allRecords.find(r => r.id === categoryId);
  if (!category) return;
  
  const products = allRecords.filter(r => r.type === 'product');
  const productIds = category.product_ids ? category.product_ids.split(',').filter(id => id) : [];
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-4xl max-h-[80vh] overflow-auto" dir="${currentLang === 'ar' ? 'rtl' : 'ltr'}">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold text-gray-800">إدارة منتجات: ${currentLang === 'ar' ? category.name_ar : category.name_en}</h3>
        <button onclick="closeModal()" class="text-2xl text-gray-500 hover:text-gray-700">×</button>
      </div>
      
      <div class="mb-6">
        <input type="text" id="productSearchInCategory" oninput="filterProductsInCategory()" placeholder="${translate('search')}..." class="w-full px-4 py-3 border rounded-lg">
      </div>
      
      <div id="productsListInCategory" class="space-y-2 max-h-[50vh] overflow-y-auto">
        ${products.map(product => {
          const isSelected = productIds.includes(product.id);
          return `
            <div class="product-checkbox-item flex items-center p-4 border rounded-lg hover:bg-gray-50">
              <input type="checkbox" id="product_${product.id}" ${isSelected ? 'checked' : ''} onchange="toggleProductInCategory('${categoryId}', '${product.id}')" class="w-5 h-5 text-purple-600 ml-3">
              <label for="product_${product.id}" class="flex-1 cursor-pointer">
                <span class="font-semibold text-gray-800">${currentLang === 'ar' ? product.name_ar : product.name_en}</span>
                <span class="text-gray-600 mr-2">(${product.price} ${translate('kwd')})</span>
              </label>
            </div>
          `;
        }).join('')}
      </div>
      
      <div class="mt-6 flex justify-end">
        <button onclick="closeModal()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
          ${translate('close')}
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function filterProductsInCategory() {
  const search = document.getElementById('productSearchInCategory').value.toLowerCase();
  const items = document.querySelectorAll('.product-checkbox-item');
  
  items.forEach(item => {
    const text = item.textContent.toLowerCase();
    item.style.display = text.includes(search) ? 'flex' : 'none';
  });
}

async function toggleProductInCategory(categoryId, productId) {
  const category = allRecords.find(r => r.id === categoryId);
  if (!category) return;
  
  let productIds = category.product_ids ? category.product_ids.split(',').filter(id => id) : [];
  
  if (productIds.includes(productId)) {
    productIds = productIds.filter(id => id !== productId);
  } else {
    productIds.push(productId);
  }
  
  const updated = {
    ...category,
    product_ids: productIds.join(',')
  };
  
  const saved = await saveToFirebase(updated);
  
  if (saved) {
    const index = allRecords.findIndex(r => r.id === categoryId);
    if (index !== -1) allRecords[index] = updated;
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  initApp();
  getDeviceId();
  getDeviceBranch();
});
</script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b8301d4d4a28308',t:'MTc2NzQ0ODY2Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
