<!doctype html>
<html lang="ar" dir="rtl">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Cairo', sans-serif;
    }
    
    html, body, #app {
      height: 100%;
      width: 100%;
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      max-width: 90%;
      max-height: 90%;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .sidebar-item {
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .sidebar-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
      transform: translateX(-5px);
    }
    
    .sidebar-item.active {
      background-color: rgba(255, 255, 255, 0.2);
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 2000;
      animation: slideIn 0.3s ease;
    }
    
    .toast.error {
      background: #ef4444;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      background: #667eea;
      color: white;
      padding: 12px;
      text-align: right;
      font-weight: 600;
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    tr:hover {
      background-color: #f9fafb;
    }
    
    .category-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    
    .category-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }
    
    .product-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    
    .product-card:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }
    
    .invoice-page {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      z-index: 999;
      overflow-y: auto;
    }
    
    
    .thermal-invoice {
  width: 70mm;
  margin: 0 auto;
  padding: 5mm;
  font-family: 'Cairo', sans-serif;
  background: white;
  font-size: 10px;
}
    
    .quantity-input {
      width: 60px;
      text-align: center;
      padding: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body>
  <div id="app"></div>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAxjBBtAnpThJoliccuoq0NNIABGPv1dJg",
      authDomain: "fawatir-b6119.firebaseapp.com",
      databaseURL: "https://fawatir-b6119-default-rtdb.firebaseio.com",
      projectId: "fawatir-b6119",
      storageBucket: "fawatir-b6119.firebasestorage.app",
      messagingSenderId: "575777677956",
      appId: "1:575777677956:web:74794fdd3525f2693d18d1"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
    const areas = [
      'Ø§Ù„Ø³Ø±Ø©', 'Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡', 'Ø§Ù„Ø³Ù„Ø§Ù…', 'Ø­Ø·ÙŠÙ†', 'Ø§Ù„ÙÙŠØ­Ø§Ø¡', 'Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ©', 'Ù…Ø´Ø±Ù', 'ÙƒÙŠÙØ§Ù†', 'Ø§Ù„Ø±ÙˆØ¶Ø©', 'Ø§Ù„Ø¹Ø¯ÙŠÙ„ÙŠØ©', 
      'Ø§Ù„Ø®Ø§Ù„Ø¯ÙŠØ©', 'Ø§Ù„Ù†Ø²Ù‡Ø©', 'Ø§Ù„Ø¯Ø¹ÙŠØ©', 'Ø§Ù„Ù…Ù†ØµÙˆØ±ÙŠØ©', 'Ù‚Ø±Ø·Ø¨Ø©', 'Ø§Ù„Ø´Ø§Ù…ÙŠØ©', 'Ø§Ù„Ø±Ù…ÙŠØ«ÙŠØ©', 'Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø³Ø§Ù„Ù…', 'Ø§Ù„Ø¬Ø§Ø¨Ø±ÙŠØ©', 
      'Ø¨ÙŠØ§Ù†', 'Ø§Ù„ØµØ¯ÙŠÙ‚', 'Ø§Ù„Ø´Ù‡Ø¯Ø§Ø¡', 'Ø§Ù„ÙŠØ±Ù…ÙˆÙƒ', 'Ø§Ù„ÙØ±ÙˆØ§Ù†ÙŠØ©', 'Ø®ÙŠØ·Ø§Ù†', 'Ø¨Ù†ÙŠØ¯ Ø§Ù„Ù‚Ø§Ø±', 'Ø§Ù„Ø¯Ø³Ù…Ø©', 'Ø­ÙˆÙ„ÙŠ', 'Ù…ÙŠØ¯Ø§Ù† Ø­ÙˆÙ„ÙŠ', 
      'Ù…Ø¨Ø§Ø±Ùƒ Ø§Ù„ÙƒØ¨ÙŠØ±', 'Ø§Ù„Ù‚ØµÙˆØ±', 'Ø§Ù„Ø±Ø§Ø¨ÙŠØ©', 'Ø§Ù„Ø¹Ù…Ø±ÙŠØ©', 'Ø§Ù„Ø±Ù‚Ø¹ÙŠ', 'ØºØ±Ù†Ø§Ø·Ø©', 'Ø§Ù„Ù‚Ø±ÙŠÙ†', 'Ø§Ù„Ø´ÙˆÙŠØ®', 'Ø§Ù„Ù…Ø³ÙŠÙ„Ø©', 'Ø§Ù„ÙƒÙˆÙŠØª', 
      'Ø§Ø´Ø¨ÙŠÙ„ÙŠØ§', 'Ø§Ù„Ø³Ø§Ù„Ù…ÙŠØ©', 'Ø´Ø±Ù‚', 'Ø§Ù„Ø±Ø­Ø§Ø¨', 'Ø§Ù„Ù…Ø±Ù‚Ø§Ø¨', 'ØµØ¨Ø§Ø­ Ø§Ù„Ø³Ø§Ù„Ù…', 'Ø§Ù„ÙØ±Ø¯ÙˆØ³', 'ØµØ¨Ø§Ø­ Ø§Ù„Ù†Ø§ØµØ±', 'Ø§Ù„Ù…Ø³Ø§ÙŠÙ„', 
      'Ø§Ù„Ø§Ù†Ø¯Ù„Ø³', 'Ø§Ù„Ø¹Ø§Ø±Ø¶ÙŠØ©', 'Ø³Ù„ÙˆÙ‰', 'Ø§Ù„Ø¹Ø¯Ø§Ù†', 'Ø§Ù„Ø´Ø¹Ø¨', 'Ù‡Ø¯ÙŠØ©', 'Ø§Ù„ØµÙ„ÙŠØ¨ÙŠØ®Ø§Øª', 'Ø§Ù„Ø¬Ù‡Ø±Ø§Ø¡', 'Ø§Ù„ÙÙ†Ø·Ø§Ø³', 'Ø³Ø¹Ø¯ Ø§Ù„Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡', 
      'Ø§Ù„ÙÙ†ÙŠØ·ÙŠØ³', 'Ø§Ù„Ø¯ÙˆØ­Ø©', 'Ø§Ù„Ø¹Ù‚ÙŠÙ„Ø©', 'Ø¬Ø§Ø¨Ø± Ø§Ù„Ø¹Ù„ÙŠ', 'Ø¬Ø§Ø¨Ø± Ø§Ù„Ø§Ø­Ù…Ø¯', 'Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø¨Ø§Ø±Ùƒ', 'Ø§Ù„Ù…Ù‡Ø¨ÙˆÙ„Ø©', 'Ø§Ù„Ù…Ù†Ù‚Ù', 'Ø§Ù„Ø§Ø­Ù…Ø¯ÙŠ', 
      'Ø§Ù„ØµÙ„ÙŠØ¨ÙŠØ©', 'Ø§Ù„ØµØ¨Ø§Ø­ÙŠØ©', 'ÙÙ‡Ø¯ Ø§Ù„Ø§Ø­Ù…Ø¯', 'ØµØ¨Ø­Ø§Ù†', 'Ø§Ø¨Ùˆ ÙØ·ÙŠØ±Ø©', 'Ø§Ø¨Ùˆ Ø§Ù„Ø­ØµØ§Ù†ÙŠØ©', 'Ø§Ù„Ø¸Ù‡Ø±', 'Ø§Ø¨Ùˆ Ø­Ù„ÙŠÙØ©', 'Ø§Ù„ÙØ­ÙŠØ­ÙŠÙ„', 
      'Ø¬Ù„ÙŠØ¨ Ø§Ù„Ø´ÙŠÙˆØ®', 'Ø§Ù… Ø§Ù„Ù‡ÙŠÙ…Ø§Ù†', 'Ø§Ù„Ù…Ø·Ù„Ø§Ø¹', 'ØµØ¨Ø§Ø­ Ø§Ù„Ø§Ø­Ù…Ø¯', 'Ø§Ù„ÙˆÙØ±Ø©'
    ];

    // Global State
    let currentScreen = 'home';
    let allProducts = [];
    let parsedExcelData = [];
    let allCategories = [];
    let allCustomers = [];
    let allOrders = [];
    let allCashiers = [];
    let currentCashier = null;
    let currentBranch = null;
    let currentOrder = {
      items: [],
      customer: null,
      deliveryPrice: 0,
      orderType: null // 'delivery' or 'pickup'
    };
    let selectedProductsForCategory = [];

    // Units
    const units = ['ÙƒÙŠÙ„Ùˆ', 'Ù„ØªØ±', 'Ø¬Ø±Ø§Ù…', 'Ø­Ø¨Ø©', 'Ø±Ø¨Ø·Ø©', 'ÙƒØ±ØªÙˆÙ†', 'ØªÙ†ÙƒØ©', 'Ø¨Ø·Ù„', 'Ù…Ø§Ø¹ÙˆÙ†'];

    // Helper Functions
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function formatDate(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleDateString('ar-SA');
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString('ar-SA');
    }

    function showToast(message, isError = false) {
      const toast = document.createElement('div');
      toast.className = `toast ${isError ? 'error' : ''}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
    
    function convertToEnglishNumbers(str) {
      const arabicNumbers = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
      const englishNumbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
      
      for (let i = 0; i < 10; i++) {
        str = str.replace(new RegExp(arabicNumbers[i], 'g'), englishNumbers[i]);
      }
      
      return str;
    }

    // Generate invoice number based on branch
    async function generateInvoiceNumber(branch) {
      // Get branch counter from Firebase
      const counterRef = db.ref('invoiceCounters/' + encodeURIComponent(branch));
      const snapshot = await counterRef.once('value');
      const currentCounter = (snapshot.val() || 0) + 1;
      
      // Update counter in Firebase
      await counterRef.set(currentCounter);
      
      // Format based on branch
      let prefix = '';
      let paddingLength = 0;
      
      if (branch === 'Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ') {
        prefix = '0';
        paddingLength = 3; // Total 3 digits (e.g., 025)
      } else if (branch === 'Ø§Ù„ÙŠØ±Ù…ÙˆÙƒ') {
        prefix = '00';
        paddingLength = 4; // Total 4 digits (e.g., 0025)
      } else if (branch === 'Ø£Ø¨Ùˆ Ø§Ù„Ø­ØµØ§Ù†ÙŠØ©') {
        prefix = '000';
        paddingLength = 5; // Total 5 digits (e.g., 00025)
      } else {
        // Default format
        prefix = '0';
        paddingLength = 3;
      }
      
      // Pad the number with zeros
      const paddedNumber = currentCounter.toString().padStart(paddingLength, '0');
      
      return paddedNumber;
    }

    // Load Data from Firebase
    async function loadData() {
      try {
        const [productsSnap, categoriesSnap, customersSnap, ordersSnap, cashiersSnap] = await Promise.all([
          db.ref('products').once('value'),
          db.ref('categories').once('value'),
          db.ref('customers').once('value'),
          db.ref('orders').once('value'),
          db.ref('cashiers').once('value')
        ]);

        allProducts = productsSnap.val() ? Object.entries(productsSnap.val()).map(([id, data]) => ({ id, ...data })) : [];
        allCategories = categoriesSnap.val() ? Object.entries(categoriesSnap.val()).map(([id, data]) => ({ id, ...data })) : [];
        allCustomers = customersSnap.val() ? Object.entries(customersSnap.val()).map(([id, data]) => ({ id, ...data })) : [];
        allOrders = ordersSnap.val() ? Object.entries(ordersSnap.val()).map(([id, data]) => ({ id, ...data })) : [];
        allCashiers = cashiersSnap.val() ? Object.entries(cashiersSnap.val()).map(([id, data]) => ({ id, ...data })) : [];

        return true;
      } catch (error) {
        console.error('Error loading data:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', true);
        return false;
      }
    }

    // Save Functions
    async function saveProduct(product) {
      try {
        const id = product.id || generateId();
        await db.ref(`products/${id}`).set({ ...product, id });
        await loadData();
        return true;
      } catch (error) {
        console.error('Error saving product:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬', true);
        return false;
      }
    }

    async function deleteProduct(id) {
      try {
        await db.ref(`products/${id}`).remove();
        await loadData();
        return true;
      } catch (error) {
        console.error('Error deleting product:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬', true);
        return false;
      }
    }

    async function saveCategory(category) {
      try {
        const id = category.id || generateId();
        await db.ref(`categories/${id}`).set({ ...category, id });
        await loadData();
        return true;
      } catch (error) {
        console.error('Error saving category:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù…', true);
        return false;
      }
    }

    async function deleteCategory(id) {
      try {
        await db.ref(`categories/${id}`).remove();
        await loadData();
        return true;
      } catch (error) {
        console.error('Error deleting category:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…', true);
        return false;
      }
    }

    async function saveCustomer(customer) {
      try {
        const id = customer.id || generateId();
        await db.ref(`customers/${id}`).set({ ...customer, id });
        await loadData();
        return true;
      } catch (error) {
        console.error('Error saving customer:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„', true);
        return false;
      }
    }

    async function deleteCustomer(id) {
      try {
        await db.ref(`customers/${id}`).remove();
        await loadData();
        return true;
      } catch (error) {
        console.error('Error deleting customer:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„', true);
        return false;
      }
    }

    async function saveCashier(cashier) {
      try {
        const id = cashier.id || generateId();
        await db.ref(`cashiers/${id}`).set({ ...cashier, id });
        await loadData();
        return true;
      } catch (error) {
        console.error('Error saving cashier:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙƒØ§Ø´ÙŠØ±', true);
        return false;
      }
    }

    async function deleteCashier(id) {
      try {
        await db.ref(`cashiers/${id}`).remove();
        await loadData();
        return true;
      } catch (error) {
        console.error('Error deleting cashier:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙƒØ§Ø´ÙŠØ±', true);
        return false;
      }
    }

    async function deleteOrder(id) {
      try {
        await db.ref(`orders/${id}`).remove();
        await loadData();
        return true;
      } catch (error) {
        console.error('Error deleting order:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨', true);
        return false;
      }
    }

    // Render Functions
    function renderHome() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="h-full w-full flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600">
          <div class="text-center text-white">
            <img src="logo.png" alt="Ø´Ø¹Ø§Ø± Ù…Ø®Ø¨Ø² Ø§Ù„ØªÙŠÙ† ÙˆØ§Ù„Ø²ÙŠØªÙˆÙ†" class="w-48 h-48 mx-auto mb-6 object-contain" onerror="this.style.display='none'; document.getElementById('fallbackIcon').style.display='block';">
            <div id="fallbackIcon" class="text-6xl mb-4" style="display: none;">ğŸ¥–</div>
            <h1 class="text-4xl font-bold mb-8">Ù…Ø®Ø¨Ø² Ø§Ù„ØªÙŠÙ† ÙˆØ§Ù„Ø²ÙŠØªÙˆÙ† / Ù…Ø·Ø¹Ù… Ø§Ù„ØªÙŠÙ† Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ</h1>
            <div class="space-y-4">
              <button onclick="showCashierLogin()" class="bg-white text-blue-600 px-8 py-4 rounded-xl font-bold text-xl hover:bg-gray-100 transition w-full max-w-md">
                ğŸ’° Ø§Ù„ÙƒØ§Ø´ÙŠØ±
              </button>
              <button onclick="showAccountingLogin()" class="bg-white text-blue-600 px-8 py-4 rounded-xl font-bold text-xl hover:bg-gray-100 transition w-full max-w-md">
                ğŸ“Š Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© ÙˆØ§Ù„Ù…Ø®Ø§Ø²Ù†
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function showAccountingLogin() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-96">
          <h2 class="text-2xl font-bold text-blue-600 mb-6">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
          <input type="password" id="passwordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 focus:border-blue-600 focus:outline-none">
          <div class="flex gap-3">
            <button onclick="loginAccounting()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition">Ø¯Ø®ÙˆÙ„</button>
            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function showCashierLogin() {
      // Check if device is registered
      const deviceId = getDeviceId();
      const deviceBranch = localStorage.getItem('deviceBranch');
      
      if (!deviceBranch) {
        showToast('Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ØºÙŠØ± Ù…Ø¹Ø±Ù. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ù„ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¬Ù‡Ø§Ø²', true);
        return;
      }
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-96">
          <h2 class="text-2xl font-bold text-blue-600 mb-6">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙƒØ§Ø´ÙŠØ±</h2>
          <div class="bg-blue-50 p-3 rounded-lg mb-4 text-center">
            <div class="text-sm text-gray-600">Ø§Ù„ÙØ±Ø¹</div>
            <div class="text-xl font-bold text-blue-600">${deviceBranch}</div>
          </div>
          <div class="mb-4">
            <label class="block mb-2 font-bold text-gray-700">Ø±Ù…Ø² Ø§Ù„ÙƒØ§Ø´ÙŠØ±</label>
            <input type="password" id="cashierCode" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
          </div>
          <div class="flex gap-3">
            <button onclick="loginCashier()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition">Ø¯Ø®ÙˆÙ„</button>
            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function loginAccounting() {
      const password = document.getElementById('passwordInput').value;
      
      if (password !== '5466') {
        showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', true);
        return;
      }
      
      document.querySelector('.modal-overlay').remove();
      await loadData();
      currentScreen = 'accounting';
      renderAccounting('orders');
    }

    async function loginCashier() {
      const code = document.getElementById('cashierCode').value;
      const deviceBranch = localStorage.getItem('deviceBranch');
      
      await loadData();
      
      const cashier = allCashiers.find(c => c.code === code);
      
      if (!cashier) {
        showToast('Ø±Ù…Ø² Ø§Ù„ÙƒØ§Ø´ÙŠØ± ØºÙŠØ± ØµØ­ÙŠØ­', true);
        return;
      }
      
      currentCashier = cashier;
      currentBranch = deviceBranch;
      document.querySelector('.modal-overlay').remove();
      currentScreen = 'cashier';
      renderCashier();
    }
    
    function getDeviceId() {
      let deviceId = localStorage.getItem('deviceId');
      if (!deviceId) {
        deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('deviceId', deviceId);
      }
      return deviceId;
    }

    // ==================== CASHIER INTERFACE ====================
    
    function renderCashier() {
      const app = document.getElementById('app');
      
      app.innerHTML = `
        <div class="flex flex-col h-full bg-gray-100">
          <!-- Header -->
          <div class="no-print bg-blue-600 text-white p-4 flex justify-between items-center">
           <div class="text-xl font-bold">${currentCashier.name} (${currentBranch})</div>
            <button onclick="logoutCashier()" class="bg-red-600 px-4 py-2 rounded-lg font-bold hover:bg-red-700 transition">
              ğŸšª Ø®Ø±ÙˆØ¬
            </button>
          </div>
          
          <!-- Main Content -->
          <div class="flex-1 p-6 overflow-y-auto">
            <div class="max-w-6xl mx-auto">
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
                <button onclick="showNewInvoicePage()" class="bg-green-600 text-white px-8 py-3 rounded-lg font-bold text-lg hover:bg-green-700 transition">
                  â• ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
                </button>
              </div>
              
              <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="overflow-x-auto">
                  <table>
                    <thead>
                      <tr>
                        <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                        <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${allOrders.filter(o => o.branch === currentBranch).map(order => `
                        <tr>
                          <td>${order.invoiceNumber}</td>
                          <td>${order.customerName}</td>
                          <td>${formatDate(order.timestamp)} ${formatTime(order.timestamp)}</td>
                          <td>${order.total.toFixed(3)} Ø¯.Ùƒ</td>
                          <td>
                            <button onclick="reprintInvoice('${order.id}')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                              ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©
                            </button>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    function showNewInvoicePage() {
      currentOrder = {
        items: [],
        customer: null,
        deliveryPrice: 0,
        orderType: null
      };
      
      const page = document.createElement('div');
      page.className = 'invoice-page';
      page.id = 'invoicePage';
      page.innerHTML = `
        <div class="h-full flex flex-col">
          <!-- Header with close button -->
          <div class="no-print bg-blue-600 text-white p-4 flex justify-between items-center">
  <h2 class="text-2xl font-bold">ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <button onclick="closeInvoicePage()" class="text-3xl font-bold hover:text-red-300">âœ•</button>
          </div>
          
          <div class="flex-1 flex overflow-hidden">
            <!-- Right side - Items list -->
            <div class="w-96 bg-white border-l-2 border-gray-300 flex flex-col">
              <div class="p-4 border-b border-gray-300">
                <h3 class="text-lg font-bold text-gray-800">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©</h3>
              </div>
              
              <div id="selectedItemsContainer" class="flex-1 overflow-y-auto p-4">
                <div class="text-center text-gray-400 py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</div>
              </div>
              
              <div class="p-4 border-t border-gray-300">
                <button id="nextButton" onclick="showOrderTypeSelection()" disabled class="w-full bg-gray-400 text-white px-6 py-3 rounded-lg font-bold cursor-not-allowed">
                  Ø§Ù„ØªØ§Ù„ÙŠ
                </button>
              </div>
            </div>
            
            <!-- Left side - Products -->
            <div class="flex-1 p-6 overflow-y-auto bg-gray-50">
              <input type="text" id="productSearchBox" oninput="searchProductsInInvoice()" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." class="w-full p-3 border-2 border-gray-300 rounded-lg mb-6 focus:border-blue-600 focus:outline-none text-lg">
              
              <div id="categoriesAndProductsContainer">
                ${renderCategoriesForInvoice()}
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(page);
    }
    
    function closeInvoicePage() {
      const page = document.getElementById('invoicePage');
      if (page) {
        page.remove();
      }
      currentOrder = {
        items: [],
        customer: null,
        deliveryPrice: 0,
        orderType: null
      };
    }
    
    function renderCategoriesForInvoice() {
      const rootCategories = allCategories.filter(c => !c.parentId);
      
      return `
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="categoriesGrid">
          ${rootCategories.map(cat => `
            <div class="category-card" onclick="showCategoryProductsInvoice('${cat.id}')">
              <div class="text-4xl mb-2">ğŸ“</div>
              <div class="font-bold text-lg">${cat.nameAr}</div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    function showCategoryProductsInvoice(categoryId) {
  const category = allCategories.find(c => c.id === categoryId);
  const subCategories = allCategories.filter(c => c.parentId === categoryId);
  const products = allProducts.filter(p => p.categoryId === categoryId);
  
  const container = document.getElementById('categoriesAndProductsContainer');
  container.innerHTML = `
    <button onclick="renderCategoriesForInvoice(); document.getElementById('categoriesAndProductsContainer').innerHTML = renderCategoriesForInvoice();" class="mb-4 bg-gray-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-gray-700 transition">
      â† Ø±Ø¬ÙˆØ¹
    </button>
    
    <h3 class="text-2xl font-bold text-gray-800 mb-4">${category.nameAr}</h3>
    
    <h4 class="text-lg font-bold text-gray-700 mb-3">Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª</h4>
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
      ${subCategories.map(subCat => `
        <div class="category-card" onclick="showCategoryProductsInvoice('${subCat.id}')">
          <div class="text-3xl mb-2">ğŸ“</div>
          <div class="font-bold">${subCat.nameAr}</div>
        </div>
      `).join('')}
      
      ${products.map(prod => `
        <div class="product-card" onclick="addProductToInvoice('${prod.id}')">
          <div class="text-4xl mb-2">ğŸ“¦</div>
          <div class="font-bold mb-1">${prod.nameAr}</div>
          <div class="text-blue-600 font-bold text-lg">${prod.price.toFixed(3)} Ø¯.Ùƒ</div>
        </div>
      `).join('')}
    </div>
  `;
}
    
    function searchProductsInInvoice() {
      const searchTerm = document.getElementById('productSearchBox').value.toLowerCase();
      
      if (searchTerm.trim() === '') {
        document.getElementById('categoriesAndProductsContainer').innerHTML = renderCategoriesForInvoice();
        return;
      }
      
      const filteredProducts = allProducts.filter(p => 
        p.nameAr.toLowerCase().includes(searchTerm) || 
        p.nameEn.toLowerCase().includes(searchTerm)
      );
      
      document.getElementById('categoriesAndProductsContainer').innerHTML = `
        <h4 class="text-lg font-bold text-gray-700 mb-3">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</h4>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          ${filteredProducts.map(prod => `
            <div class="product-card" onclick="addProductToInvoice('${prod.id}')">
              <div class="text-4xl mb-2">ğŸ“¦</div>
              <div class="font-bold mb-1">${prod.nameAr}</div>
              <div class="text-blue-600 font-bold text-lg">${prod.price.toFixed(3)} Ø¯.Ùƒ</div>
              <div class="text-sm text-gray-600">${prod.unit}</div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    function addProductToInvoice(productId) {
      const product = allProducts.find(p => p.id === productId);
      const existingItem = currentOrder.items.find(item => item.productId === productId);
      
      if (existingItem) {
        existingItem.quantity += 1;
        existingItem.total = existingItem.quantity * existingItem.price;
      } else {
        currentOrder.items.push({
          productId: product.id,
          productName: product.nameAr,
          productNameEn: product.nameEn,
          price: product.price,
          quantity: 1,
          unit: product.unit || '',
          total: product.price
        });
      }
      
      updateSelectedItemsDisplay();
    }
    
    function updateSelectedItemsDisplay() {
      const container = document.getElementById('selectedItemsContainer');
      const nextButton = document.getElementById('nextButton');
      
      if (currentOrder.items.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-400 py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</div>';
        nextButton.disabled = true;
        nextButton.className = 'w-full bg-gray-400 text-white px-6 py-3 rounded-lg font-bold cursor-not-allowed';
      } else {
        container.innerHTML = currentOrder.items.map((item, index) => `
          <div class="bg-gray-50 p-3 rounded-lg mb-2">
            <div class="flex justify-between items-start mb-2">
              <div class="font-bold">${item.productName}</div>
              <button onclick="removeItemFromInvoice(${index})" class="text-red-600 hover:text-red-800 font-bold text-lg">âœ•</button>
            </div>
            <div class="flex items-center gap-2">
              <input type="text" value="${item.quantity}" readonly onclick="showNumericKeypadForInvoice(${index}, this)" class="quantity-input bg-white cursor-pointer">
              <span class="text-sm text-gray-600">Ã— ${item.price.toFixed(3)}</span>
              <span class="font-bold text-blue-600 mr-auto">${item.total.toFixed(3)} Ø¯.Ùƒ</span>
            </div>
          </div>
        `).join('');
        
        nextButton.disabled = false;
        nextButton.className = 'w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition';
      }
    }
    
    function updateItemQuantity(index, value) {
      value = convertToEnglishNumbers(value);
      const quantity = parseFloat(value);
      
      if (isNaN(quantity) || quantity <= 0) {
        return;
      }
      
      currentOrder.items[index].quantity = quantity;
      currentOrder.items[index].total = quantity * currentOrder.items[index].price;
      updateSelectedItemsDisplay();
    }
    
    function removeItemFromInvoice(index) {
      currentOrder.items.splice(index, 1);
      updateSelectedItemsDisplay();
    }
function showNumericKeypadForInvoice(index, inputField) {
  if (document.querySelector('.numeric-keypad-overlay')) return;
  
  const overlay = document.createElement('div');
  overlay.className = 'numeric-keypad-overlay';
  overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
  
  const keypad = document.createElement('div');
  keypad.style.cssText = 'background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);';
  
  const display = document.createElement('input');
  display.type = 'text';
  display.value = inputField.value || '0';
  display.readOnly = true;
  display.style.cssText = 'width: 100%; font-size: 32px; text-align: center; padding: 15px; margin-bottom: 15px; border: 2px solid #2563eb; border-radius: 8px; font-weight: bold;';
  
  const buttonsContainer = document.createElement('div');
  buttonsContainer.style.cssText = 'display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 300px;';
  
  const buttons = ['7', '8', '9', '4', '5', '6', '1', '2', '3', '.', '0', 'Ù…Ø³Ø­', 'Ù…ÙˆØ§ÙÙ‚'];
  
  buttons.forEach(btn => {
    const button = document.createElement('button');
    button.textContent = btn;
    button.style.cssText = 'padding: 20px; font-size: 24px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;';
    
    if (btn === 'Ù…ÙˆØ§ÙÙ‚') {
      button.style.background = '#22c55e';
      button.style.color = 'white';
    } else if (btn === 'Ù…Ø³Ø­') {
      button.style.background = '#ef4444';
      button.style.color = 'white';
    } else {
      button.style.background = '#e5e7eb';
      button.style.color = '#1f2937';
    }
    
    button.onmouseover = () => {
      button.style.transform = 'scale(1.05)';
      button.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
    };
    
    button.onmouseout = () => {
      button.style.transform = 'scale(1)';
      button.style.boxShadow = 'none';
    };
    
    button.onclick = () => {
      if (btn === 'Ù…ÙˆØ§ÙÙ‚') {
        const newValue = display.value;
        updateItemQuantity(index, newValue);
        overlay.remove();
      } else if (btn === 'Ù…Ø³Ø­') {
        display.value = '0';
      } else if (btn === '.') {
        if (display.value === '0') {
          display.value = '0.';
        } else if (!display.value.includes('.')) {
          display.value += '.';
        }
      } else {
        if (display.value === '0') {
          display.value = btn;
        } else {
          display.value += btn;
        }
      }
    };
    
    buttonsContainer.appendChild(button);
  });
  
  keypad.appendChild(display);
  keypad.appendChild(buttonsContainer);
  overlay.appendChild(keypad);
  
  overlay.onclick = (e) => {
    if (e.target === overlay) overlay.remove();
  };
  
  document.body.appendChild(overlay);
}

    
     function showOrderTypeSelection() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-96">
          <h2 class="text-2xl font-bold text-blue-600 mb-6 text-center">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>
          
          <div class="mb-4">
            <label class="block mb-2 font-bold text-gray-700">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
            <div class="grid grid-cols-2 gap-3 mb-4">
              <button onclick="selectPaymentMethod('cash')" id="cashBtn" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-green-500 hover:text-white transition">
                ğŸ’µ ÙƒØ§Ø´
              </button>
              <button onclick="selectPaymentMethod('online')" id="onlineBtn" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-blue-500 hover:text-white transition">
                ğŸ’³ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
              </button>
            </div>
          </div>
          
          <div class="mb-4">
            <label class="block mb-2 font-bold text-gray-700">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <textarea id="orderNotes" rows="3" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨..." class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"></textarea>
          </div>
          
          <div class="space-y-4">
            <button onclick="selectOrderType('delivery')" id="deliveryBtn" disabled class="w-full bg-gray-400 text-white px-6 py-4 rounded-lg font-bold text-xl cursor-not-allowed transition">
              ğŸšš ØªÙˆØµÙŠÙ„
            </button>
            <button onclick="selectOrderType('pickup')" id="pickupBtn" disabled class="w-full bg-gray-400 text-white px-6 py-4 rounded-lg font-bold text-xl cursor-not-allowed transition">
              ğŸ›ï¸ Ø§Ø³ØªÙ„Ø§Ù…
            </button>
          </div>
          <button onclick="this.closest('.modal-overlay').remove()" class="w-full mt-4 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      `;
      document.body.appendChild(modal);
    }
    

        let selectedPaymentMethod = null;
    
    function selectPaymentMethod(method) {
      selectedPaymentMethod = method;
      
      // ØªØºÙŠÙŠØ± Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±
      const cashBtn = document.getElementById('cashBtn');
      const onlineBtn = document.getElementById('onlineBtn');
      const deliveryBtn = document.getElementById('deliveryBtn');
      const pickupBtn = document.getElementById('pickupBtn');
      
      if (method === 'cash') {
        cashBtn.className = 'bg-green-600 text-white px-6 py-3 rounded-lg font-bold transition';
        onlineBtn.className = 'bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-blue-500 hover:text-white transition';
      } else {
        onlineBtn.className = 'bg-blue-600 text-white px-6 py-3 rounded-lg font-bold transition';
        cashBtn.className = 'bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-green-500 hover:text-white transition';
      }
      
      // ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨
      deliveryBtn.disabled = false;
      deliveryBtn.className = 'w-full bg-green-600 text-white px-6 py-4 rounded-lg font-bold text-xl hover:bg-green-700 transition';
      pickupBtn.disabled = false;
      pickupBtn.className = 'w-full bg-blue-600 text-white px-6 py-4 rounded-lg font-bold text-xl hover:bg-blue-700 transition';
    }


        function selectOrderType(type) {
      if (!selectedPaymentMethod) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ø£ÙˆÙ„Ø§Ù‹', true);
        return;
      }
      
      currentOrder.orderType = type;
      currentOrder.paymentMethod = selectedPaymentMethod;
      currentOrder.notes = document.getElementById('orderNotes').value.trim();
      document.querySelector('.modal-overlay').remove();
  
  if (type === 'delivery') {
    showCustomerSelectionForDelivery();
  } else {
    showPickupCustomerInfo();
  }
}
    
    function showCustomerSelectionForDelivery() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-full max-w-4xl">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-blue-600">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
            <button onclick="showAddCustomerForDelivery()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700 transition">
              â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„
            </button>
          </div>
          
          <input type="text" id="customerSearchDelivery" oninput="filterCustomersDelivery()" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„..." class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 focus:border-blue-600 focus:outline-none">
          
          <div class="max-h-96 overflow-y-auto">
            ${allCustomers.map(customer => `
              <div class="customer-delivery-item bg-gray-50 p-4 rounded-lg mb-2 cursor-pointer hover:bg-blue-50 transition" data-search="${customer.name} ${customer.phone}" onclick="selectCustomerForDelivery('${customer.id}')">
                <div class="font-bold text-lg">${customer.name}</div>
                <div class="text-gray-600">${customer.phone}</div>
              </div>
            `).join('')}
          </div>
          
          <button onclick="this.closest('.modal-overlay').remove()" class="w-full mt-4 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    function filterCustomersDelivery() {
      const searchTerm = document.getElementById('customerSearchDelivery').value.toLowerCase();
      const items = document.querySelectorAll('.customer-delivery-item');
      
      items.forEach(item => {
        const searchData = item.getAttribute('data-search').toLowerCase();
        item.style.display = searchData.includes(searchTerm) ? '' : 'none';
      });
    }
    
    function selectCustomerForDelivery(customerId) {
      const customer = allCustomers.find(c => c.id === customerId);
      currentOrder.customer = customer;
      document.querySelector('.modal-overlay').remove();
      showDeliveryDetails();
    }
    
    function showAddCustomerForDelivery() {
      document.querySelector('.modal-overlay').remove();
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-full max-w-2xl">
          <h2 class="text-2xl font-bold text-blue-600 mb-6">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h2>
          
          <div class="space-y-4">
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
              <input type="text" id="newCustomerNameDelivery" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
            </div>
            
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
              <div class="flex gap-2">
                <input type="text" id="newCustomerPrefix" value="965" class="w-24 p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                <input type="text" id="newCustomerPhoneDelivery" oninput="this.value = convertToEnglishNumbers(this.value)" class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
              </div>
            </div>
            
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
              <select id="newCustomerArea" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</option>
                ${areas.map(area => `<option value="${area}">${area}</option>`).join('')}
                <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰ (ÙƒØªØ§Ø¨Ø© ÙŠØ¯ÙˆÙŠØ©)</option>
              </select>
              <input type="text" id="newCustomerAreaManual" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©" class="w-full p-3 border-2 border-gray-300 rounded-lg mt-2 hidden focus:border-blue-600 focus:outline-none">
            </div>
            
            <div>
              <label class="block mb-2 font-bold text-gray-700">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
              <textarea id="newCustomerAddress" rows="3" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"></textarea>
            </div>
          </div>
          
          <div class="flex gap-3 mt-6">
            <button onclick="saveNewCustomerDelivery()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition">Ø­ÙØ¸</button>
            <button onclick="this.closest('.modal-overlay').remove(); showCustomerSelectionForDelivery()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      document.getElementById('newCustomerArea').addEventListener('change', function() {
        const manualInput = document.getElementById('newCustomerAreaManual');
        if (this.value === 'Ø£Ø®Ø±Ù‰') {
          manualInput.classList.remove('hidden');
        } else {
          manualInput.classList.add('hidden');
        }
      });
    }
    
    async function saveNewCustomerDelivery() {
      const name = document.getElementById('newCustomerNameDelivery').value.trim();
      const prefix = document.getElementById('newCustomerPrefix').value.trim();
      const phone = document.getElementById('newCustomerPhoneDelivery').value.trim();
      let area = document.getElementById('newCustomerArea').value;
      const address = document.getElementById('newCustomerAddress').value.trim();
      
      if (!name || !phone) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', true);
        return;
      }
      
      if (area === 'Ø£Ø®Ø±Ù‰') {
        area = document.getElementById('newCustomerAreaManual').value.trim();
      }
      
      if (!area) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', true);
        return;
      }
      
      const customer = {
        name,
        phone: prefix + phone,
        addresses: [{ area, details: address }]
      };
      
      const success = await saveCustomer(customer);
      if (success) {
        showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
        currentOrder.customer = allCustomers[allCustomers.length - 1];
        document.querySelector('.modal-overlay').remove();
        showDeliveryDetails();
      }
    }
    
    function showDeliveryDetails() {
      const customer = currentOrder.customer;
      const hasAddresses = customer.addresses && customer.addresses.length > 0;
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-full max-w-2xl">
          <h2 class="text-2xl font-bold text-blue-600 mb-6">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙˆØµÙŠÙ„</h2>
          
          <div class="bg-blue-50 p-4 rounded-lg mb-6">
            <div class="text-lg font-bold">${customer.name}</div>
            <div class="text-gray-600">${customer.phone}</div>
          </div>
          
          ${hasAddresses ? `
            <div class="mb-4">
              <label class="block mb-2 font-bold text-gray-700">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
              <select id="selectedAddress" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                ${customer.addresses.map((addr, idx) => `
                  <option value="${idx}">${addr.area} - ${addr.details}</option>
                `).join('')}
                <option value="new">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</option>
              </select>
            </div>
            
            <div id="newAddressFields" class="hidden space-y-4 mb-4">
              <div>
                <label class="block mb-2 font-bold text-gray-700">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                <select id="newAddressArea" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</option>
                  ${areas.map(area => `<option value="${area}">${area}</option>`).join('')}
                  <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰ (ÙƒØªØ§Ø¨Ø© ÙŠØ¯ÙˆÙŠØ©)</option>
                </select>
                <input type="text" id="newAddressAreaManual" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©" class="w-full p-3 border-2 border-gray-300 rounded-lg mt-2 hidden focus:border-blue-600 focus:outline-none">
              </div>
              
              <div>
                <label class="block mb-2 font-bold text-gray-700">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                <textarea id="newAddressDetails" rows="3" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"></textarea>
              </div>
            </div>
          ` : `
            <div class="space-y-4 mb-4">
              <div>
                <label class="block mb-2 font-bold text-gray-700">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
                <select id="deliveryArea" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</option>
                  ${areas.map(area => `<option value="${area}">${area}</option>`).join('')}
                  <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰ (ÙƒØªØ§Ø¨Ø© ÙŠØ¯ÙˆÙŠØ©)</option>
                </select>
                <input type="text" id="deliveryAreaManual" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©" class="w-full p-3 border-2 border-gray-300 rounded-lg mt-2 hidden focus:border-blue-600 focus:outline-none">
              </div>
              
              <div>
                <label class="block mb-2 font-bold text-gray-700">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                <textarea id="deliveryAddressDetails" rows="3" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"></textarea>
              </div>
            </div>
          `}
          
          <div class="mb-6">
            <label class="block mb-2 font-bold text-gray-700">Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø¯.Ùƒ)</label>
            <input type="text" id="deliveryPrice" oninput="this.value = convertToEnglishNumbers(this.value)" value="0" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
          </div>
          
          <div class="flex gap-3">
            <button onclick="finalizeDeliveryOrder()" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 transition">Ø§Ù„ØªØ§Ù„ÙŠ</button>
            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      if (hasAddresses) {
        document.getElementById('selectedAddress').addEventListener('change', function() {
          const newFields = document.getElementById('newAddressFields');
          if (this.value === 'new') {
            newFields.classList.remove('hidden');
          } else {
            newFields.classList.add('hidden');
          }
        });
        
        document.getElementById('newAddressArea').addEventListener('change', function() {
          const manualInput = document.getElementById('newAddressAreaManual');
          if (this.value === 'Ø£Ø®Ø±Ù‰') {
            manualInput.classList.remove('hidden');
          } else {
            manualInput.classList.add('hidden');
          }
        });
      } else {
        document.getElementById('deliveryArea').addEventListener('change', function() {
          const manualInput = document.getElementById('deliveryAreaManual');
          if (this.value === 'Ø£Ø®Ø±Ù‰') {
            manualInput.classList.remove('hidden');
          } else {
            manualInput.classList.add('hidden');
          }
        });
      }
    }
    
    async function finalizeDeliveryOrder() {
      const customer = currentOrder.customer;
      const hasAddresses = customer.addresses && customer.addresses.length > 0;
      
      let area, addressDetails;
      
      if (hasAddresses) {
        const selectedIdx = document.getElementById('selectedAddress').value;
        
        if (selectedIdx === 'new') {
          area = document.getElementById('newAddressArea').value;
          if (area === 'Ø£Ø®Ø±Ù‰') {
            area = document.getElementById('newAddressAreaManual').value.trim();
          }
          addressDetails = document.getElementById('newAddressDetails').value.trim();
          
          if (!area || !addressDetails) {
            showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„', true);
            return;
          }
          
          // Add new address to customer
          customer.addresses.push({ area, details: addressDetails });
          await saveCustomer(customer);
        } else {
          const address = customer.addresses[parseInt(selectedIdx)];
          area = address.area;
          addressDetails = address.details;
        }
      } else {
        area = document.getElementById('deliveryArea').value;
        if (area === 'Ø£Ø®Ø±Ù‰') {
          area = document.getElementById('deliveryAreaManual').value.trim();
        }
        addressDetails = document.getElementById('deliveryAddressDetails').value.trim();
        
        if (!area || !addressDetails) {
          showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ÙƒØ§Ù…Ù„', true);
          return;
        }
        
        // Add address to customer
        customer.addresses = [{ area, details: addressDetails }];
        await saveCustomer(customer);
      }
      
      const deliveryPrice = parseFloat(convertToEnglishNumbers(document.getElementById('deliveryPrice').value)) || 0;
      currentOrder.deliveryPrice = deliveryPrice;
      currentOrder.selectedAddress = { area, details: addressDetails };
      
      document.querySelector('.modal-overlay').remove();
      printAndSaveInvoice();
    }
    
    function showPickupCustomerInfo() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-full max-w-2xl">
          <h2 class="text-2xl font-bold text-blue-600 mb-6">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ø³ØªÙ„Ø§Ù…)</h2>
          
          <div class="mb-4">
            <button onclick="selectExistingCustomerPickup()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition mb-2">
              Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­ÙÙˆØ¸ÙŠÙ†
            </button>
            <div class="text-center text-gray-500 mb-2">Ø£Ùˆ</div>
          </div>
          
          <div class="space-y-4">
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
              <input type="text" id="pickupCustomerName" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
            </div>
            
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
              <div class="flex gap-2">
                <input type="text" id="pickupCustomerPrefix" value="965" class="w-24 p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                <input type="text" id="pickupCustomerPhone" oninput="this.value = convertToEnglishNumbers(this.value)" class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
              </div>
            </div>
          </div>
          
          <div class="flex gap-3 mt-6">
            <button onclick="finalizePickupOrder()" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 transition">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    function selectExistingCustomerPickup() {
      document.querySelector('.modal-overlay').remove();
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-full max-w-4xl">
          <h2 class="text-2xl font-bold text-blue-600 mb-6">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
          
          <input type="text" id="customerSearchPickup" oninput="filterCustomersPickup()" placeholder="ğŸ” Ø¨Ø­Ø«..." class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 focus:border-blue-600 focus:outline-none">
          
          <div class="max-h-96 overflow-y-auto">
            ${allCustomers.map(customer => `
              <div class="customer-pickup-item bg-gray-50 p-4 rounded-lg mb-2 cursor-pointer hover:bg-blue-50 transition" data-search="${customer.name} ${customer.phone}" onclick="selectCustomerPickup('${customer.id}')">
                <div class="font-bold text-lg">${customer.name}</div>
                <div class="text-gray-600">${customer.phone}</div>
              </div>
            `).join('')}
          </div>
          
          <button onclick="this.closest('.modal-overlay').remove(); showPickupCustomerInfo()" class="w-full mt-4 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    function filterCustomersPickup() {
      const searchTerm = document.getElementById('customerSearchPickup').value.toLowerCase();
      const items = document.querySelectorAll('.customer-pickup-item');
      
      items.forEach(item => {
        const searchData = item.getAttribute('data-search').toLowerCase();
        item.style.display = searchData.includes(searchTerm) ? '' : 'none';
      });
    }
    
    function selectCustomerPickup(customerId) {
      const customer = allCustomers.find(c => c.id === customerId);
      currentOrder.customer = {
        name: customer.name,
        phone: customer.phone
      };
      document.querySelector('.modal-overlay').remove();
      printAndSaveInvoice();
    }
    
    function finalizePickupOrder() {
      const name = document.getElementById('pickupCustomerName').value.trim();
      const prefix = document.getElementById('pickupCustomerPrefix').value.trim();
      const phone = document.getElementById('pickupCustomerPhone').value.trim();
      
      if (!name || !phone) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', true);
        return;
      }
      
      currentOrder.customer = {
        name,
        phone: prefix + phone
      };
      
      document.querySelector('.modal-overlay').remove();
      printAndSaveInvoice();
    }
    
    async function printAndSaveInvoice() {
      // Get branch-specific invoice number
      const invoiceNumber = await generateInvoiceNumber(currentBranch);
      const timestamp = Date.now();
      
      // Clean items to ensure all fields have valid values
      const cleanedItems = currentOrder.items.map(item => ({
        productId: item.productId || '',
        productName: item.productName || '',
        productNameEn: item.productNameEn || '', 
        price: item.price || 0,
        quantity: item.quantity || 0,
        total: item.total || 0,
        unit: item.unit || ''
      }));
      
      const order = {
        invoiceNumber,
        timestamp,
        cashier: currentCashier.name || '',
        cashierCode: currentCashier.code || '',
        branch: currentBranch || '',
        customerName: currentOrder.customer.name || '',
        phoneNumber: currentOrder.customer.phone || '',
        orderType: currentOrder.orderType || '',
        paymentMethod: currentOrder.paymentMethod || '',
        address: currentOrder.selectedAddress ? `${currentOrder.selectedAddress.area} - ${currentOrder.selectedAddress.details}` : '',
        items: cleanedItems,
        deliveryPrice: currentOrder.deliveryPrice || 0,
        notes: currentOrder.notes || '',
        total: currentOrder.items.reduce((sum, item) => sum + item.total, 0) + (currentOrder.deliveryPrice || 0)
      };
      
      try {
        const orderId = generateId();
        await db.ref(`orders/${orderId}`).set({ ...order, id: orderId });
        await loadData();
        
        closeInvoicePage();
        showThermalInvoice(order);
        showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­');
      } catch (error) {
        console.error('Error saving order:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©', true);
      }
    }
    
    function showThermalInvoice(order) {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content p-4" style="background: #f3f4f6;">
      <div class="thermal-invoice" style="width: 72mm; margin: 0 auto; padding: 10px; background: white; border-radius: 8px;">
        <div style="text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px;">
          <img src="logo.png" alt="Ø§Ù„Ø´Ø¹Ø§Ø±" style="width: 100px; height: 100px; margin: 0 auto 10px auto; display: block; object-fit: contain;" onerror="this.style.display='none';">
          <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">Ù…Ø®Ø¨Ø² Ø§Ù„ØªÙŠÙ† ÙˆØ§Ù„Ø²ÙŠØªÙˆÙ†</div>
          <div style="font-size: 8px; line-height: 1.4;">
            Ø§Ù„ÙƒÙˆÙŠØªØŒ Ø§Ù„ÙŠØ±Ù…ÙˆÙƒØŒ Ù‚Ù¢ Ø´Ø§Ø±Ø¹ Ù¢<br>
            22085889 | 65162277<br>
            @figsolives.kw
          </div>
          
          <div style="margin: 10px 0; border-top: 1px solid #ccc; padding: 5px 0;">
            <div style="font-size: 16px; font-weight: bold; margin-bottom: 3px;">Ù…Ø·Ø¹Ù… Ø§Ù„ØªÙŠÙ† Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ</div>
            <div style="font-size: 8px; line-height: 1.4;">
              Ø§Ù„ÙƒÙˆÙŠØªØŒ Ø£Ø¨Ùˆ Ø§Ù„Ø­ØµØ§Ù†ÙŠØ©ØŒ Ù…ÙˆÙ„ Ù£Ù <br>
              22085886 | 99176512<br>
              @natural_figs
            </div>
          </div>
        </div>
        
        <div style="margin-bottom: 8px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; font-size: 11px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
            <span>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: <strong>#${order.invoiceNumber}</strong></span>
            <span>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${formatDate(order.timestamp)}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span>Ø§Ù„ÙƒØ§Ø´ÙŠØ±: ${order.cashier}</span>
            <span>Ø§Ù„ÙˆÙ‚Øª: ${formatTime(order.timestamp)}</span>
          </div>
        </div>
        
        <div style="background: #f9f9f9; padding: 5px; border-radius: 3px; margin-bottom: 8px; font-size: 11px;">
          <div style="font-weight: bold; border-bottom: 1px solid #eee; margin-bottom: 3px;">Ø§Ù„Ø¹Ù…ÙŠÙ„: ${order.customerName}</div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
            <span>ğŸ“ ${order.phoneNumber.replace(/^\+?965\s?/, '')}</span>
            <span style="background: #000; color: #fff; padding: 0 5px; border-radius: 2px;">${order.orderType === 'delivery' ? 'ØªÙˆØµÙŠÙ„' : 'Ø§Ø³ØªÙ„Ø§Ù…'}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span>${order.address ? `ğŸ“ ${order.address}` : ''}</span>
            <span style="background: #000; color: #fff; padding: 0 5px; border-radius: 2px;">${order.paymentMethod === 'cash' ? 'ÙƒØ§Ø´' : 'Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†'}</span>
          </div>
        </div>

        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
          <thead>
            <tr>
              <th style="text-align: right; border-bottom: 1px solid #000; padding: 4px 0;">Ø§Ù„ØµÙ†Ù</th>
              <th style="text-align: center; width: 40px; border-bottom: 1px solid #000; padding: 4px 0;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th style="text-align: left; width: 60px; border-bottom: 1px solid #000; padding: 4px 0;">Ø§Ù„Ø³Ø¹Ø±</th>
            </tr>
          </thead>
          <tbody>
              ${order.items.map(item => `
              <tr>
                <td style="padding: 4px 0; border-bottom: 1px dotted #eee;">
                  <div style="font-weight: 700;">${item.productName}</div>
                  ${item.productNameEn ? `<div style="font-size: 9px; color: #666;">${item.productNameEn}</div>` : ''}
                  ${item.notes ? `<div style="font-size: 10px; color: #0066cc; margin-top: 2px; font-weight: 600;">ğŸ“ ${item.notes}</div>` : ''}
                </td>
                <td style="text-align: center; font-weight: bold; padding: 4px 0; border-bottom: 1px dotted #eee;">${item.quantity}</td>
                <td style="text-align: left; padding: 4px 0; border-bottom: 1px dotted #eee;">${item.total.toFixed(3)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>

        <div style="margin-top: 10px; border-top: 1px solid #000; padding-top: 5px; font-size: 11px;">
          <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 2px;">
            <span>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù:</span>
            <span>${order.items.reduce((sum, item) => sum + item.total, 0).toFixed(3)} Ø¯.Ùƒ</span>
          </div>
          ${order.deliveryPrice > 0 ? `
            <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 2px;">
              <span>Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„:</span>
              <span>${order.deliveryPrice.toFixed(3)} Ø¯.Ùƒ</span>
            </div>
          ` : ''}
          <div style="display: flex; justify-content: space-between; font-size: 14px; font-weight: 900; margin-top: 5px; border-top: 2px double #000; padding-top: 5px;">
            <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
            <span>${order.total.toFixed(3)} Ø¯.Ùƒ</span>
          </div>
        </div>

        ${order.notes ? `
<div style="background: #fffbeb; border: 1px dashed #fbbf24; border-radius: 4px; padding: 8px; margin-top: 10px; font-size: 11px;">
  <div style="font-weight: bold; margin-bottom: 3px; color: #92400e;">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</div>
  <div style="color: #451a03; line-height: 1.4;">${order.notes}</div>
</div>
` : ''}

        <div style="text-align: center; margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px;">
          <div style="font-size: 11px; font-weight: bold;">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ…!</div>
          <div style="font-size: 9px; color: #666; margin-top: 3px;">ØµØ­ØªÙƒ Ø£ØºÙ„Ù‰ Ù…Ø§ ØªÙ…Ù„ÙƒØŒØŒ ÙØªÙ†Ø§ÙˆÙ„ Ø´ÙŠØ¦Ø§Ù‹ ØµØ­ÙŠØ§Ù‹.</div>
        </div>
      </div>
      
      <div class="mt-4 flex gap-2">
        <button onclick="printThermalInvoice(this)" style="flex: 2; background: #2563eb; color: white; padding: 12px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer;">
          ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
        </button>
        <button onclick="this.closest('.modal-overlay').remove();" style="flex: 1; background: #e5e7eb; color: #374151; padding: 12px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer;">
          Ø¥Ù„ØºØ§Ø¡
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}


function printThermalInvoice(button) {
  const invoiceContent = button.closest('.modal-content').querySelector('.thermal-invoice').innerHTML;
  
  const printWindow = window.open('', '_blank', 'width=800,height=600');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html dir="rtl" lang="ar">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</title>
      <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
      <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }
        
        @page {
          size: 80mm auto;
          margin: 0;
        }
        
        html, body {
          margin: 0;
          padding: 0;
          width: 80mm;
          height: auto;
        }
        
        body {
          font-family: 'Cairo', sans-serif;
          background: white;
          padding: 3mm 2mm;
          font-size: 15px;
        }
        
        .thermal-invoice {
          width: 100%;
          max-width: 69mm;
          margin: 0 auto;
          padding: 0;
        }
        
        .thermal-invoice * {
          font-size: 15px !important;
          line-height: 1.5;
          letter-spacing: 0.3px;
        }
        
        .thermal-invoice strong,
        .thermal-invoice b {
          font-size: 17px !important;
          font-weight: 700;
        }
        
        @media print {
          html, body {
            height: auto;
            overflow: visible;
          }
          
          body {
            padding: 2mm;
            font-size: 15px;
          }
          
          .thermal-invoice {
            page-break-after: avoid;
          }
          
          .thermal-invoice * {
            font-size: 15px !important;
          }
          
          .thermal-invoice strong,
          .thermal-invoice b {
            font-size: 17px !important;
          }
        }
      </style>
    </head>
    <body>
      <div class="thermal-invoice">
        ${invoiceContent}
      </div>
      <script>
        window.print();
        window.onafterprint = function() {
          window.close();
        };
      <\/script>
    </body>
    </html>
  `);
  printWindow.document.close();
}

    
    function reprintInvoice(orderId) {
      const order = allOrders.find(o => o.id === orderId);
      if (order) {
        showThermalInvoice(order);
      }
    }

    function logoutCashier() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-96 text-center">
          <h2 class="text-2xl font-bold text-blue-600 mb-4">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬</h2>
          <p class="text-gray-600 mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ</p>
          <div class="flex gap-3">
            <button onclick="confirmLogoutCashier()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition">Ù†Ø¹Ù…</button>
            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ù„Ø§</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function confirmLogoutCashier() {
      currentCashier = null;
      currentBranch = null;
      currentOrder = {
        items: [],
        customer: null,
        deliveryPrice: 0,
        orderType: null
      };
      document.querySelector('.modal-overlay').remove();
      currentScreen = 'home';
      renderHome();
    }

    // ==================== ACCOUNTING INTERFACE ====================

    function renderAccounting(section) {
      const app = document.getElementById('app');
      
      app.innerHTML = `
        <div class="flex h-full">
          <div class="w-64 bg-gray-800 text-white p-6">
            <h2 class="text-2xl font-bold mb-8">ğŸ“Š Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©</h2>
            <div class="space-y-2">
              <div class="sidebar-item ${section === 'orders' ? 'active' : ''} p-3 rounded-lg" onclick="renderAccounting('orders')">
                ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
              </div>
              <div class="sidebar-item ${section === 'customers' ? 'active' : ''} p-3 rounded-lg" onclick="renderAccounting('customers')">
                ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
              </div>
              <div class="sidebar-item ${section === 'products' ? 'active' : ''} p-3 rounded-lg" onclick="renderAccounting('products')">
                ğŸ›ï¸ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
              </div>
              <div class="sidebar-item ${section === 'categories' ? 'active' : ''} p-3 rounded-lg" onclick="renderAccounting('categories')">
                ğŸ“ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
              </div>
              <div class="sidebar-item ${section === 'devices' ? 'active' : ''} p-3 rounded-lg" onclick="renderAccounting('devices')">
                ğŸ–¥ï¸ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„ÙƒØ§Ø´ÙŠØ±
              </div>
            </div>
            <button onclick="logout()" class="w-full mt-8 bg-red-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-red-700 transition">Ø®Ø±ÙˆØ¬</button>
          </div>
          
          <div class="flex-1 p-8 overflow-y-auto bg-gray-50">
            <div id="contentArea">
              ${renderAccountingContent(section)}
            </div>
          </div>
        </div>
      `;
    }

    function logout() {
      currentScreen = 'home';
      renderHome();
    }

    function renderAccountingContent(section) {
      switch(section) {
        case 'orders': return renderOrdersSection();
        case 'customers': return renderCustomersSection();
        case 'products': return renderProductsSection();
        case 'categories': return renderCategoriesSection();
        case 'devices': return renderDevicesSection();
        default: return '';
      }
    }

    // Orders Section
    function renderOrdersSection() {
  return `
    <div>
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-bold text-blue-600">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
        <div class="flex gap-3">
          <button onclick="printAllVisibleInvoices()" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-purple-700 transition">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</button>
          <button onclick="exportToExcel()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 transition">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Excel</button>
        </div>
      </div>
      
      <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label class="block mb-2 font-bold text-gray-700">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
            <input type="date" id="filterFrom" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
          </div>
          <div>
            <label class="block mb-2 font-bold text-gray-700">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
            <input type="date" id="filterTo" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
          </div>
          <div>
            <label class="block mb-2 font-bold text-gray-700">Ø§Ù„ÙƒØ§Ø´ÙŠØ±</label>
            <select id="filterCashier" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              ${allCashiers.map(c => `<option value="${c.code}">${c.name}</option>`).join('')}
            </select>
          </div>
          <div>
            <label class="block mb-2 font-bold text-gray-700">Ø§Ù„ÙØ±Ø¹</label>
            <select id="filterBranch" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>
              <option value="Ø£Ø¨Ùˆ Ø§Ù„Ø­ØµØ§Ù†ÙŠØ©">Ø£Ø¨Ùˆ Ø§Ù„Ø­ØµØ§Ù†ÙŠØ©</option>
              <option value="Ø§Ù„ÙŠØ±Ù…ÙˆÙƒ">Ø§Ù„ÙŠØ±Ù…ÙˆÙƒ</option>
            </select>
          </div>
        </div>
        <button onclick="applyFilters()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition">Ø¨Ø­Ø«</button>
      </div>
      
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <input type="text" id="orderSearch" placeholder="Ø¨Ø­Ø«..." oninput="filterOrders()" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 focus:border-blue-600 focus:outline-none">
        <div class="overflow-x-auto">
          <table>
            <thead>
              <tr>
                <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„ÙƒØ§Ø´ÙŠØ±</th>
                <th>Ø§Ù„ÙØ±Ø¹</th>
                <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="ordersBody">
              ${allOrders.map(order => `
                <tr class="order-row" data-search="${order.invoiceNumber || ''} ${order.customerName || ''} ${order.phoneNumber || ''}" data-cashier="${order.cashierCode || ''}" data-branch="${order.branch || ''}" data-timestamp="${order.timestamp || 0}">
                  <td>${order.invoiceNumber || 'N/A'}</td>
                  <td>${order.customerName || 'N/A'}</td>
                  <td>${order.phoneNumber || 'N/A'}</td>
                  <td>${formatDate(order.timestamp)}</td>
                  <td>${order.cashier || 'N/A'}</td>
                  <td>${order.branch || 'N/A'}</td>
                  <td>${order.paymentMethod === 'cash' ? 'ğŸ’µ ÙƒØ§Ø´' : order.paymentMethod === 'online' ? 'ğŸ’³ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†' : 'N/A'}</td>
                  <td>${order.total ? order.total.toFixed(3) : '0.000'} Ø¯.Ùƒ</td>
                  <td>
                    <button onclick="viewOrder('${order.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition">Ø¹Ø±Ø¶</button>
                    <button onclick="editOrder('${order.id}')" class="bg-yellow-600 text-white px-3 py-1 rounded text-sm hover:bg-yellow-700 transition">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button onclick="confirmDeleteOrder('${order.id}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition">Ø­Ø°Ù</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
}

    function filterOrders() {
      const searchTerm = document.getElementById('orderSearch').value.toLowerCase();
      const rows = document.querySelectorAll('.order-row');
      
      rows.forEach(row => {
        const searchData = row.getAttribute('data-search').toLowerCase();
        row.style.display = searchData.includes(searchTerm) ? '' : 'none';
      });
    }

    function applyFilters() {
      const fromDate = document.getElementById('filterFrom').value;
      const toDate = document.getElementById('filterTo').value;
      const cashier = document.getElementById('filterCashier').value;
      const branch = document.getElementById('filterBranch').value;
      
      const rows = document.querySelectorAll('.order-row');
      
      rows.forEach(row => {
        const timestamp = parseInt(row.getAttribute('data-timestamp'));
        const rowCashier = row.getAttribute('data-cashier');
        const rowBranch = row.getAttribute('data-branch');
        
        let show = true;
        
        if (fromDate) {
          const from = new Date(fromDate).getTime();
          if (timestamp < from) show = false;
        }
        
        if (toDate) {
          const to = new Date(toDate).getTime() + 86400000;
          if (timestamp > to) show = false;
        }
        
        if (cashier && rowCashier !== cashier) show = false;
        if (branch && rowBranch !== branch) show = false;
        
        row.style.display = show ? '' : 'none';
      });
    }

        function exportToExcel() {
  const rows = document.querySelectorAll('.order-row');
  let totalNet = 0;
  let totalDelivery = 0;
  let totalFinal = 0;
  let data = [];
  
  rows.forEach(row => {
    if (row.style.display !== 'none') {
      const cells = row.cells;
      
      // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„ØµÙ
      const orderId = cells[0].textContent.trim().replace('#', '');
      const order = allOrders.find(o => o.invoiceNumber === orderId);
      
      if (order) {
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
        const deliveryFee = parseFloat(order.deliveryFee) || parseFloat(order.deliveryPrice) || 0;
        const netAmount = parseFloat(order.total) - deliveryFee;
        const finalTotal = parseFloat(order.total) || 0;
        
        totalNet += netAmount;
        totalDelivery += deliveryFee;
        totalFinal += finalTotal;
        
        // Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒØ§Ø¦Ù† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙˆØ¬ÙˆØ¯ Ø¹Ù…ÙˆØ¯ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
        const totalCellIndex = cells.length === 9 ? 7 : 6;
        
        if (cells.length === 9) {
          // Ù…Ø¹ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
          data.push({
            'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©': cells[0].textContent.trim(),
            'Ø§Ù„Ø¹Ù…ÙŠÙ„': cells[1].textContent.trim(),
            'Ø§Ù„Ù‡Ø§ØªÙ': cells[2].textContent.trim(),
            'Ø§Ù„ØªØ§Ø±ÙŠØ®': cells[3].textContent.trim(),
            'Ø§Ù„ÙƒØ§Ø´ÙŠØ±': cells[4].textContent.trim(),
            'Ø§Ù„ÙØ±Ø¹': cells[5].textContent.trim(),
            'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹': cells[6].textContent.trim(),
            'ØµØ§ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©': netAmount.toFixed(3),
            'Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„': deliveryFee.toFixed(3),
            'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ': finalTotal.toFixed(3)
          });
        } else {
          // Ø¨Ø¯ÙˆÙ† Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
          data.push({
            'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©': cells[0].textContent.trim(),
            'Ø§Ù„Ø¹Ù…ÙŠÙ„': cells[1].textContent.trim(),
            'Ø§Ù„Ù‡Ø§ØªÙ': cells[2].textContent.trim(),
            'Ø§Ù„ØªØ§Ø±ÙŠØ®': cells[3].textContent.trim(),
            'Ø§Ù„ÙƒØ§Ø´ÙŠØ±': cells[4].textContent.trim(),
            'Ø§Ù„ÙØ±Ø¹': cells[5].textContent.trim(),
            'ØµØ§ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©': netAmount.toFixed(3),
            'Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„': deliveryFee.toFixed(3),
            'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ': finalTotal.toFixed(3)
          });
        }
      }
    }
  });
  
  if (data.length === 0) {
    showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
    return;
  }
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ HTML Ù…Ù†Ø³Ù‚ Ù„Ù€ Excel
  let html = `
    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
    <head>
      <meta charset="utf-8">
      <style>
        table { border-collapse: collapse; width: 100%; direction: rtl; }
        th { background-color: #4472C4; color: white; font-weight: bold; padding: 12px; border: 1px solid #ddd; text-align: center; }
        td { padding: 10px; border: 1px solid #ddd; text-align: center; }
        .total-row { background-color: #FFC000; font-weight: bold; font-size: 14px; }
        tr:nth-child(even) { background-color: #F2F2F2; }
      </style>
    </head>
    <body>
      <table dir="rtl">
        <thead>
          <tr>
            ${Object.keys(data[0]).map(key => `<th>${key}</th>`).join('')}
          </tr>
        </thead>
        <tbody>
          ${data.map(row => `
            <tr>
              ${Object.values(row).map(val => `<td>${val}</td>`).join('')}
            </tr>
          `).join('')}
          <tr class="total-row">
            ${Object.keys(data[0]).map((key, index) => {
              if (key === 'Ø§Ù„ÙØ±Ø¹' || key === 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹') {
                return `<td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</td>`;
              } else if (key === 'ØµØ§ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©') {
                return `<td>${totalNet.toFixed(3)}</td>`;
              } else if (key === 'Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„') {
                return `<td>${totalDelivery.toFixed(3)}</td>`;
              } else if (key === 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ') {
                return `<td>${totalFinal.toFixed(3)}</td>`;
              } else {
                return `<td></td>`;
              }
            }).join('')}
          </tr>
        </tbody>
      </table>
    </body>
    </html>
  `;
  
  // ØªØ­Ù…ÙŠÙ„ ÙƒÙ…Ù„Ù Excel
  const blob = new Blob(['\ufeff', html], { 
    type: 'application/vnd.ms-excel' 
  });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø·Ù„Ø¨Ø§Øª_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}.xls`;
  link.click();
  
  showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel Ø¨Ù†Ø¬Ø§Ø­');
}

    function printAllVisibleInvoices() {
  const rows = document.querySelectorAll('.order-row');
  let visibleOrders = [];
  
  rows.forEach(row => {
    if (row.style.display !== 'none') {
      const orderId = row.cells[0].textContent.trim().replace('#', '');
      const order = allOrders.find(o => o.invoiceNumber === orderId);
      if (order) {
        visibleOrders.push(order);
      }
    }
  });
  
  if (visibleOrders.length === 0) {
    showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
    return;
  }
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
  const printWindow = window.open('', '_blank');
  
  let allInvoicesHtml = `
    <!DOCTYPE html>
    <html dir="rtl">
    <head>
      <meta charset="UTF-8">
      <title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</title>
      <style>
        @page {
          size: 80mm auto;
          margin: 0;
        }
        body {
          font-family: 'Tajawal', Arial, sans-serif;
          margin: 0;
          padding: 0;
        }
        .invoice-page {
          width: 80mm;
          padding: 10mm;
          page-break-after: always;
          background: white;
        }
        .invoice-page:last-child {
          page-break-after: auto;
        }
        .header {
          text-align: center;
          border-bottom: 2px dashed #000;
          padding-bottom: 10px;
          margin-bottom: 15px;
        }
        .header h1 {
          margin: 0;
          font-size: 24px;
          font-weight: bold;
        }
        .header p {
          margin: 5px 0;
          font-size: 12px;
        }
        .info-row {
          display: flex;
          justify-content: space-between;
          margin: 8px 0;
          font-size: 14px;
        }
        .info-row strong {
          font-weight: bold;
        }
        .items-table {
          width: 100%;
          margin: 15px 0;
          border-collapse: collapse;
        }
        .items-table th {
          background: #f0f0f0;
          padding: 8px;
          text-align: right;
          font-size: 12px;
          border-bottom: 2px solid #000;
        }
        .items-table td {
          padding: 8px;
          text-align: right;
          font-size: 12px;
          border-bottom: 1px dashed #ccc;
        }
        .totals {
          margin-top: 15px;
          padding-top: 10px;
          border-top: 2px dashed #000;
        }
        .total-row {
          display: flex;
          justify-content: space-between;
          margin: 8px 0;
          font-size: 14px;
        }
        .total-row.final {
          font-size: 18px;
          font-weight: bold;
          margin-top: 10px;
        }
        .footer {
          text-align: center;
          margin-top: 20px;
          padding-top: 10px;
          border-top: 2px dashed #000;
          font-size: 12px;
        }
        @media print {
          body {
            margin: 0;
            padding: 0;
          }
        }
      </style>
    </head>
    <body>
  `;
  
  // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„ ÙØ§ØªÙˆØ±Ø©
  visibleOrders.forEach((order, index) => {
    const deliveryFee = parseFloat(order.deliveryFee) || parseFloat(order.deliveryPrice) || 0;
    const netAmount = parseFloat(order.total) - deliveryFee;
    
    allInvoicesHtml += `
      <div class="invoice-page">
        <div class="header">
          <h1>ğŸ• ${order.branch || 'Ø§Ù„Ù…Ø·Ø¹Ù…'}</h1>
          <p>ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù…: <strong>#${order.invoiceNumber}</strong></p>
          <p>${new Date(order.timestamp).toLocaleString('ar-SA')}</p>
        </div>
        
        <div class="info-row">
          <span><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${order.customerName}</span>
        </div>
        <div class="info-row">
          <span><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${order.phoneNumber}</span>
        </div>
        ${order.address ? `
        <div class="info-row">
          <span><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${order.address}</span>
        </div>
        ` : ''}
        <div class="info-row">
          <span><strong>Ø§Ù„ÙƒØ§Ø´ÙŠØ±:</strong> ${order.cashier}</span>
        </div>
        <div class="info-row">
          <span><strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</strong> ${order.paymentMethod === 'cash' ? 'ğŸ’µ ÙƒØ§Ø´' : order.paymentMethod === 'online' ? 'ğŸ’³ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†' : 'N/A'}</span>
        </div>
        
        <table class="items-table">
          <thead>
            <tr>
              <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th style="text-align: center;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th style="text-align: left;">Ø§Ù„Ø³Ø¹Ø±</th>
            </tr>
          </thead>
          <tbody>
            ${(order.items || []).map(item => `
              <tr>
                <td>${item.productName}</td>
                <td style="text-align: center;">${item.quantity} ${item.unit}</td>
                <td style="text-align: left;">${(item.total || 0).toFixed(3)} Ø¯.Ùƒ</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        
        <div class="totals">
          <div class="total-row">
            <span>ØµØ§ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</span>
            <span>${netAmount.toFixed(3)} Ø¯.Ùƒ</span>
          </div>
          ${deliveryFee > 0 ? `
          <div class="total-row">
            <span>Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„:</span>
            <span>${deliveryFee.toFixed(3)} Ø¯.Ùƒ</span>
          </div>
          ` : ''}
          <div class="total-row final">
            <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
            <span>${parseFloat(order.total).toFixed(3)} Ø¯.Ùƒ</span>
          </div>
        </div>
        
        <div class="footer">
          <p>Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ… ğŸŒŸ</p>
          <p>Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… ÙŠÙˆÙ…Ø§Ù‹ Ø³Ø¹ÙŠØ¯Ø§Ù‹</p>
        </div>
      </div>
    `;
  });
  
  allInvoicesHtml += `
    </body>
    </html>
  `;
  
  printWindow.document.write(allInvoicesHtml);
  printWindow.document.close();
  
  // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø«Ù… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
  setTimeout(() => {
    printWindow.print();
  }, 500);
  
  showToast(`Ø¬Ø§Ø±ÙŠ Ø·Ø¨Ø§Ø¹Ø© ${visibleOrders.length} ÙØ§ØªÙˆØ±Ø©...`);
}

    function viewOrder(orderId) {
      const order = allOrders.find(o => o.id === orderId);
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-full max-w-2xl">
          <h2 class="text-2xl font-bold text-blue-600 mb-6">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>
          
          <div class="bg-gray-50 p-4 rounded-lg mb-6">
            <div class="grid grid-cols-2 gap-4">
              <div><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> ${order.invoiceNumber}</div>
              <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${formatDate(order.timestamp)}</div>
              <div><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${order.customerName}</div>
              <div><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${order.phoneNumber}</div>
              ${order.address ? `<div class="col-span-2"><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${order.address}</div>` : ''}
              <div><strong>Ø§Ù„ÙƒØ§Ø´ÙŠØ±:</strong> ${order.cashier}</div>
              <div><strong>Ø§Ù„ÙØ±Ø¹:</strong> ${order.branch}</div>
              <div><strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</strong> ${order.paymentMethod === 'cash' ? 'ğŸ’µ ÙƒØ§Ø´' : order.paymentMethod === 'online' ? 'ğŸ’³ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†' : 'N/A'}</div>
            </div>
          </div>
          
          <h3 class="text-xl font-bold mb-4">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
          <div class="border-2 border-gray-200 rounded-lg p-4 mb-6 max-h-64 overflow-y-auto">
            ${(order.items || []).map(item => `
              <div class="flex justify-between py-2 border-b border-gray-200">
                <div>
                  <div class="font-bold">${item.productName}</div>
                  <div class="text-sm text-gray-600">${item.price ? item.price.toFixed(3) : '0.000'} Ã— ${item.quantity} ${item.unit}</div>
                </div>
                <div class="font-bold text-blue-600">${item.total ? item.total.toFixed(3) : '0.000'}</div>
              </div>
            `).join('')}
            ${order.deliveryPrice > 0 ? `
              <div class="flex justify-between py-2 border-b border-gray-200">
                <div class="font-bold">Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</div>
                <div class="font-bold text-blue-600">${order.deliveryPrice.toFixed(3)}</div>
              </div>
            ` : ''}
            <div class="flex justify-between py-4 text-lg font-bold text-blue-600">
              <div>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</div>
              <div>${order.total ? order.total.toFixed(3) : '0.000'} Ø¯.Ùƒ</div>
            </div>
          </div>
          
          <button onclick="this.closest('.modal-overlay').remove()" class="w-full bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function confirmDeleteOrder(orderId) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-96 text-center">
          <h2 class="text-2xl font-bold text-red-600 mb-4">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h2>
          <p class="text-gray-600 mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ</p>
          <div class="flex gap-3">
            <button onclick="deleteOrderConfirmed('${orderId}')" class="flex-1 bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition">Ù†Ø¹Ù…</button>
            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ù„Ø§</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function deleteOrderConfirmed(orderId) {
      const success = await deleteOrder(orderId);
      if (success) {
        document.querySelector('.modal-overlay').remove();
        renderAccounting('orders');
        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
      }
    }

    // Customers Section
    function renderCustomersSection() {
      return `
        <div>
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-blue-600">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
            <button onclick="showAddCustomerModal()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
          </div>
          
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <input type="text" id="customerSearch" placeholder="Ø¨Ø­Ø«..." oninput="filterCustomers()" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 focus:border-blue-600 focus:outline-none">
            <div class="overflow-x-auto">
              <table>
                <thead>
                  <tr>
                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                    <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                    <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                  </tr>
                </thead>
                <tbody id="customersBody">
                  ${allCustomers.map(customer => {
                    const ordersCount = allOrders.filter(o => o.phoneNumber === customer.phone).length;
                    return `
                      <tr class="customer-row" data-search="${customer.name} ${customer.phone}">
                        <td>${customer.name}</td>
                        <td>${customer.phone}</td>
                        <td>${ordersCount}</td>
                        <td>
                          <button onclick="viewCustomer('${customer.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition">Ø¹Ø±Ø¶</button>
                          <button onclick="editCustomer('${customer.id}')" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition">ØªØ¹Ø¯ÙŠÙ„</button>
                          <button onclick="confirmDeleteCustomer('${customer.id}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition">Ø­Ø°Ù</button>
                        </td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function filterCustomers() {
      const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
      const rows = document.querySelectorAll('.customer-row');
      
      rows.forEach(row => {
        const searchData = row.getAttribute('data-search').toLowerCase();
        row.style.display = searchData.includes(searchTerm) ? '' : 'none';
      });
    }

    function showAddCustomerModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-full max-w-lg">
          <h2 class="text-2xl font-bold text-blue-600 mb-6">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h2>
          <div class="space-y-4">
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ù„Ø§Ø³Ù…</label>
              <input type="text" id="newCustomerName" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
            </div>
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
              <div class="flex gap-2">
                <input type="text" id="newCustomerPrefix" value="965" class="w-20 p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                <input type="text" id="newCustomerPhone" class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
              </div>
            </div>
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="addCustomer()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition">Ø¥Ø¶Ø§ÙØ©</button>
            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function addCustomer() {
      const name = document.getElementById('newCustomerName').value.trim();
      const prefix = document.getElementById('newCustomerPrefix').value.trim();
      const phone = document.getElementById('newCustomerPhone').value.trim();
      
      if (!name || !phone) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', true);
        return;
      }
      
      const customer = {
        name,
        phone: prefix + phone,
        addresses: []
      };
      
      const success = await saveCustomer(customer);
      if (success) {
        showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
        document.querySelector('.modal-overlay').remove();
        renderAccounting('customers');
      }
    }

    function viewCustomer(customerId) {
      const customer = allCustomers.find(c => c.id === customerId);
      const customerOrders = allOrders.filter(o => o.phoneNumber === customer.phone);
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-full max-w-3xl">
          <h2 class="text-2xl font-bold text-blue-600 mb-6">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
          
          <div class="bg-gray-50 p-4 rounded-lg mb-6">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <div class="text-sm text-gray-600">Ø§Ù„Ø§Ø³Ù…</div>
                <div class="text-lg font-bold">${customer.name}</div>
              </div>
              <div>
                <div class="text-sm text-gray-600">Ø§Ù„Ù‡Ø§ØªÙ</div>
                <div class="text-lg font-bold">${customer.phone}</div>
              </div>
            </div>
            
            ${customer.addresses && customer.addresses.length > 0 ? `
              <div class="mt-4 pt-4 border-t border-gray-200">
                <div class="text-sm text-gray-600 mb-2">Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†</div>
                ${customer.addresses.map(addr => `
                  <div class="bg-white p-3 rounded-lg mb-2">
                    <div class="font-bold">${addr.area}</div>
                    <div class="text-sm text-gray-600">${addr.details}</div>
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
          
          <h3 class="text-xl font-bold mb-4">Ø§Ù„Ø·Ù„Ø¨Ø§Øª (${customerOrders.length})</h3>
          <div class="max-h-96 overflow-y-auto">
            <table>
              <thead>
                <tr>
                  <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„ÙØ±Ø¹</th>
                  <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                </tr>
              </thead>
              <tbody>
                ${customerOrders.map(order => `
                  <tr>
                    <td>${order.invoiceNumber}</td>
                    <td>${formatDate(order.timestamp)}</td>
                    <td>${order.branch}</td>
                    <td>${order.total.toFixed(3)} Ø¯.Ùƒ</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          
          <button onclick="this.closest('.modal-overlay').remove()" class="w-full mt-6 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function editCustomer(customerId) {
      const customer = allCustomers.find(c => c.id === customerId);
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-full max-w-lg">
          <h2 class="text-2xl font-bold text-blue-600 mb-6">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
          <div class="space-y-4">
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ù„Ø§Ø³Ù…</label>
              <input type="text" id="editCustomerName" value="${customer.name}" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
            </div>
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
              <input type="text" id="editCustomerPhone" value="${customer.phone}" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
            </div>
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="saveEditedCustomer('${customerId}')" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition">Ø­ÙØ¸</button>
            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function saveEditedCustomer(customerId) {
      const name = document.getElementById('editCustomerName').value.trim();
      const phone = document.getElementById('editCustomerPhone').value.trim();
      
      if (!name || !phone) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', true);
        return;
      }
      
      const customer = allCustomers.find(c => c.id === customerId);
      customer.name = name;
      customer.phone = phone;
      
      const success = await saveCustomer(customer);
      if (success) {
        showToast('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
        document.querySelector('.modal-overlay').remove();
        renderAccounting('customers');
      }
    }

    function confirmDeleteCustomer(customerId) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-96 text-center">
          <h2 class="text-2xl font-bold text-red-600 mb-4">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h2>
          <p class="text-gray-600 mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ</p>
          <div class="flex gap-3">
            <button onclick="deleteCustomerConfirmed('${customerId}')" class="flex-1 bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition">Ù†Ø¹Ù…</button>
            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ù„Ø§</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function deleteCustomerConfirmed(customerId) {
      const success = await deleteCustomer(customerId);
      if (success) {
        document.querySelector('.modal-overlay').remove();
        renderAccounting('customers');
        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
      }
    }

    // Products Section (rest of accounting functions remain the same...)
    function renderProductsSection() {
      return `
        <div>
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-blue-600">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
            <div class="flex gap-3">
              <button onclick="showImportExcelModal()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 transition">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel</button>
              <button onclick="showAddProductModal()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
            </div>
          </div>
          
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <input type="text" id="productSearch" placeholder="Ø¨Ø­Ø«..." oninput="filterProducts()" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 focus:border-blue-600 focus:outline-none">
            <div class="overflow-x-auto">
              <table>
                <thead>
                  <tr>
                    <th>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ</th>
                    <th>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</th>
                    <th>Ø§Ù„Ø³Ø¹Ø±</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                  </tr>
                </thead>
                <tbody id="productsBody">
                  ${allProducts.map(product => `
                    <tr class="product-row" data-search="${product.nameAr} ${product.nameEn}">
                      <td>${product.nameAr}</td>
                      <td>${product.nameEn}</td>
                      <td>${product.price ? product.price.toFixed(3) : '0.000'} Ø¯.Ùƒ</td>
                      <td>
                        <button onclick="editProduct('${product.id}')" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button onclick="confirmDeleteProduct('${product.id}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition">Ø­Ø°Ù</button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function filterProducts() {
      const searchTerm = document.getElementById('productSearch').value.toLowerCase();
      const rows = document.querySelectorAll('.product-row');
      
      rows.forEach(row => {
        const searchData = row.getAttribute('data-search').toLowerCase();
        row.style.display = searchData.includes(searchTerm) ? '' : 'none';
      });
    }

    function showImportExcelModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-full max-w-2xl">
          <h2 class="text-2xl font-bold text-blue-600 mb-6">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Excel</h2>
          
          <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mb-6">
            <div class="font-bold text-blue-800 mb-2">ğŸ“‹ ØªØ¹Ù„ÙŠÙ…Ø§Øª ØªØ­Ø¶ÙŠØ± Ù…Ù„Ù Excel:</div>
            <ol class="list-decimal list-inside text-sm text-blue-900 space-y-1">
              <li>ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ 3 Ø£Ø¹Ù…Ø¯Ø© ÙÙ‚Ø· Ø¨Ù†ÙØ³ Ø§Ù„ØªØ±ØªÙŠØ¨</li>
              <li>Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„: <strong>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ</strong></li>
              <li>Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ: <strong>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</strong></li>
              <li>Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù„Ø«: <strong>Ø§Ù„Ø³Ø¹Ø±</strong> (Ø¨Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„ÙƒÙˆÙŠØªÙŠ)</li>
              <li>Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£ÙˆÙ„ Ø³ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡ (Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©)</li>
              <li>ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ù†Ù…ÙˆØ°Ø¬ÙŠ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</li>
            </ol>
          </div>
          
          <div class="mb-6">
            <button onclick="downloadExcelTemplate()" class="w-full bg-purple-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-purple-700 transition mb-4">
              ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel Ù†Ù…ÙˆØ°Ø¬ÙŠ
            </button>
            
            <label class="block mb-2 font-bold text-gray-700">Ø§Ø®ØªØ± Ù…Ù„Ù Excel</label>
            <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
          </div>
          
          <div id="importPreview" class="hidden mb-6">
            <h3 class="font-bold text-gray-800 mb-2">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</h3>
            <div class="max-h-64 overflow-y-auto border-2 border-gray-200 rounded-lg p-3 bg-gray-50">
              <div id="importPreviewContent"></div>
            </div>
          </div>
          
          <div class="flex gap-3">
            <button id="importButton" onclick="processExcelImport()" disabled class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
              âœ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            </button>
            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Add file change listener
      document.getElementById('excelFileInput').addEventListener('change', handleExcelFileSelect);
    }

    function downloadExcelTemplate() {
      // Create sample data
      const sampleData = [
        ['Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ', 'Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ', 'Ø§Ù„Ø³Ø¹Ø±'],
        ['Ø®Ø¨Ø² ØªÙ†ÙˆØ±', 'Tanoor Bread', '0.250'],
        ['Ø®Ø¨Ø² ØµÙ…ÙˆÙ†', 'Samoon Bread', '0.350'],
        ['ÙƒÙŠÙƒ Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©', 'Chocolate Cake', '2.500'],
        ['Ù…Ø¹Ø¬Ù†Ø§Øª Ø²Ø¹ØªØ±', 'Zaatar Pastry', '0.500']
      ];
      
      // Convert to CSV
      let csv = '\uFEFF'; // UTF-8 BOM for Arabic support
      sampleData.forEach(row => {
        csv += row.join(',') + '\n';
      });
      
      // Download
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'Ù†Ù…ÙˆØ°Ø¬_Ø§Ø³ØªÙŠØ±Ø§Ø¯_Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.csv';
      link.click();
      
      showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
    }

    let importedProductsData = [];

    function handleExcelFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const rows = text.split('\n').filter(row => row.trim() !== '');
          
          // Skip header row
          const dataRows = rows.slice(1);
          
          importedProductsData = [];
          let previewHTML = '';
          
          dataRows.forEach((row, index) => {
            // Handle both comma and tab separators
            let columns = row.split(',');
            if (columns.length < 3) {
              columns = row.split('\t');
            }
            
            if (columns.length >= 3) {
              const nameAr = columns[0].trim().replace(/^"|"$/g, '');
              const nameEn = columns[1].trim().replace(/^"|"$/g, '');
              const priceStr = columns[2].trim().replace(/^"|"$/g, '');
              const price = parseFloat(priceStr);
              
              if (nameAr && nameEn && !isNaN(price)) {
                importedProductsData.push({ nameAr, nameEn, price });
                previewHTML += `
                  <div class="flex justify-between py-2 border-b border-gray-200">
                    <div>
                      <span class="font-bold">${nameAr}</span> / 
                      <span class="text-gray-600">${nameEn}</span>
                    </div>
                    <div class="font-bold text-blue-600">${price.toFixed(3)} Ø¯.Ùƒ</div>
                  </div>
                `;
              }
            }
          });
          
          if (importedProductsData.length > 0) {
            document.getElementById('importPreview').classList.remove('hidden');
            document.getElementById('importPreviewContent').innerHTML = previewHTML;
            document.getElementById('importButton').disabled = false;
            showToast(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${importedProductsData.length} Ù…Ù†ØªØ¬`);
          } else {
            showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬Ø§Øª ØµØ§Ù„Ø­Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù', true);
          }
          
        } catch (error) {
          console.error('Error reading file:', error);
          showToast('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù', true);
        }
      };
      
      reader.readAsText(file, 'UTF-8');
    }

    
    async function processExcelImport() {
      if (!parsedExcelData || parsedExcelData.length === 0) {
        showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', true);
        return;
      }
      
      try {
        // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ø£ÙƒØ³Ù„
        const excelProducts = parsedExcelData.map((row, index) => ({
          id: `P${Date.now()}_${index}`,
          nameAr: row[0],
          nameEn: row[1],
          price: parseFloat(row[2]) || 0,
          unit: 'Ø­Ø¨Ø©'
        }));
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        const productsRef = ref(database, `products/${currentBranch}`);
        const snapshot = await get(productsRef);
        const existingProducts = snapshot.exists() ? snapshot.val() : [];
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
        const duplicates = [];
        const newProducts = [];
        
        excelProducts.forEach(excelProduct => {
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø£Ùˆ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ
          const exists = existingProducts.some(p => {
            const nameArMatch = p.nameAr && excelProduct.nameAr && 
              p.nameAr.trim().toLowerCase() === excelProduct.nameAr.trim().toLowerCase();
            const nameEnMatch = p.nameEn && excelProduct.nameEn && 
              p.nameEn.trim().toLowerCase() === excelProduct.nameEn.trim().toLowerCase();
            return nameArMatch || nameEnMatch;
          });
          
          if (exists) {
            duplicates.push(excelProduct.nameAr);
          } else {
            newProducts.push(excelProduct);
          }
        });
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
        if (duplicates.length > 0) {
          const duplicatesList = duplicates.slice(0, 10).join('\n');
          const moreText = duplicates.length > 10 ? `\n... Ùˆ ${duplicates.length - 10} Ù…Ù†ØªØ¬Ø§Øª Ø£Ø®Ø±Ù‰` : '';
          
          const confirmMsg = `âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${duplicates.length} Ù…Ù†ØªØ¬ Ù…ÙƒØ±Ø±:\n\n${duplicatesList}${moreText}\n\nâœ… Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© ${newProducts.length} Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯ ÙÙ‚Ø·.\nâŒ Ø³ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©.\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`;
          
          if (!confirm(confirmMsg)) {
            showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', true);
            return;
          }
        } else if (newProducts.length > 0) {
          const confirmMsg = `âœ… Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© ${newProducts.length} Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯.\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`;
          if (!confirm(confirmMsg)) {
            showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', true);
            return;
          }
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø·
        if (newProducts.length > 0) {
          await set(productsRef, [...existingProducts, ...newProducts]);
          
          allProducts = [...existingProducts, ...newProducts];
          renderProducts();
          
          document.querySelector('.modal-overlay').remove();
          
          const successMsg = duplicates.length > 0 ? 
            `âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${newProducts.length} Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯\nâš ï¸ ØªÙ… ØªØ¬Ø§Ù‡Ù„ ${duplicates.length} Ù…Ù†ØªØ¬ Ù…ÙƒØ±Ø±` :
            `âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${newProducts.length} Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­`;
          
          showToast(successMsg);
        } else {
          showToast('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¥Ø¶Ø§ÙØ©. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„!', true);
        }
        
      } catch (error) {
        console.error('Import error:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', true);
      }
    }

    function showAddProductModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-full max-w-lg">
          <h2 class="text-2xl font-bold text-blue-600 mb-6">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h2>
          <div class="space-y-4">
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ</label>
              <input type="text" id="newProductNameAr" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
            </div>
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</label>
              <input type="text" id="newProductNameEn" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
            </div>
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ù„Ø³Ø¹Ø±</label>
              <input type="number" step="0.001" id="newProductPrice" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
            </div>
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
              <select id="newProductUnit" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                ${units.map(unit => `<option value="${unit}">${unit}</option>`).join('')}
              </select>
            </div>
            <div>
              <div><label class="block mb-2 font-bold text-gray-700">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</label> 
              <input type="text" id="newProductStock" value="0" readonly class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none bg-white cursor-pointer" onclick="showNumericKeypad(this)">

            </div>
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="addProduct()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition">Ø¥Ø¶Ø§ÙØ©</button>
            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function addProduct() {
      const nameAr = document.getElementById('newProductNameAr').value.trim();
      const nameEn = document.getElementById('newProductNameEn').value.trim();
      const price = parseFloat(document.getElementById('newProductPrice').value);
      const unit = document.getElementById('newProductUnit').value;
      const stock = parseFloat(document.getElementById('newProductStock').value) || 0;
      
      if (!nameAr || !nameEn || isNaN(price)) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', true);
        return;
      }
      
      const product = {
        nameAr,
        nameEn,
        price,
        unit,
        stock,
        categoryId: null
      };
      
      const success = await saveProduct(product);
      if (success) {
        showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­');
        document.querySelector('.modal-overlay').remove();
        renderAccounting('products');
      }
    }

    function editProduct(productId) {
      const product = allProducts.find(p => p.id === productId);
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-full max-w-lg">
          <h2 class="text-2xl font-bold text-blue-600 mb-6">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h2>
          <div class="space-y-4">
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ</label>
              <input type="text" id="editProductNameAr" value="${product.nameAr}" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
            </div>
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</label>
              <input type="text" id="editProductNameEn" value="${product.nameEn}" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-600">
            </div>
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ù„Ø³Ø¹Ø±</label>
              <input type="number" step="0.001" id="editProductPrice" value="${product.price}" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
            </div>
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
              <select id="editProductUnit" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                ${units.map(unit => `<option value="${unit}" ${product.unit === unit ? 'selected' : ''}>${unit}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</label>
              <input type="number" id="editProductStock" value="${product.stock || 0}" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
            </div>
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="saveEditedProduct('${productId}')" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition">Ø­ÙØ¸</button>
            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function saveEditedProduct(productId) {
      const nameAr = document.getElementById('editProductNameAr').value.trim();
      const nameEn = document.getElementById('editProductNameEn').value.trim();
      const price = parseFloat(document.getElementById('editProductPrice').value);
      const unit = document.getElementById('editProductUnit').value;
      const stock = parseFloat(document.getElementById('editProductStock').value) || 0;
      
      if (!nameAr || !nameEn || isNaN(price)) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', true);
        return;
      }
      
      const product = allProducts.find(p => p.id === productId);
      product.nameAr = nameAr;
      product.nameEn = nameEn;
      product.price = price;
      product.unit = unit;
      product.stock = stock;
      
      const success = await saveProduct(product);
      if (success) {
        showToast('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­');
        document.querySelector('.modal-overlay').remove();
        renderAccounting('products');
      }
    }

    function confirmDeleteProduct(productId) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-96 text-center">
          <h2 class="text-2xl font-bold text-red-600 mb-4">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h2>
          <p class="text-gray-600 mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ</p>
          <div class="flex gap-3">
            <button onclick="deleteProductConfirmed('${productId}')" class="flex-1 bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition">Ù†Ø¹Ù…</button>
            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ù„Ø§</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function deleteProductConfirmed(productId) {
      const success = await deleteProduct(productId);
      if (success) {
        document.querySelector('.modal-overlay').remove();
        renderAccounting('products');
        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­');
      }
    }

    // Categories Section
    function renderCategoriesSection() {
      const rootCategories = allCategories.filter(c => !c.parentId);
      
      return `
        <div>
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-blue-600">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>
            <button onclick="showAddCategoryModal(null)" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition">â• Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…</button>
          </div>
          
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <input type="text" id="categorySearch" placeholder="Ø¨Ø­Ø«..." oninput="filterCategories()" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 focus:border-blue-600 focus:outline-none">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
              ${rootCategories.map(category => {
                const productsCount = allProducts.filter(p => p.categoryId === category.id).length;
                const subCategoriesCount = allCategories.filter(c => c.parentId === category.id).length;
                return `
                  <div class="category-card category-search-card" data-search="${category.nameAr} ${category.nameEn}" onclick="viewCategory('${category.id}')">
                    <div class="text-5xl mb-4">ğŸ“</div>
                    <div class="text-xl font-bold mb-2">${category.nameAr}</div>
                    <div class="text-sm opacity-90 mb-4">${category.nameEn}</div>
                    <div class="pt-4 border-t border-white border-opacity-30">
                      <div class="text-sm">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${productsCount}</div>
                      <div class="text-sm">Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ©: ${subCategoriesCount}</div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function filterCategories() {
      const searchTerm = document.getElementById('categorySearch').value.toLowerCase();
      const cards = document.querySelectorAll('.category-search-card');
      
      cards.forEach(card => {
        const searchData = card.getAttribute('data-search').toLowerCase();
        card.style.display = searchData.includes(searchTerm) ? '' : 'none';
      });
    }

    function viewCategory(categoryId) {
      const category = allCategories.find(c => c.id === categoryId);
if (!category) {
  showToast('Ø§Ù„ÙØ¦Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', true);
  return;
}
      const subCategories = allCategories.filter(c => c.parentId === categoryId);
      const products = allProducts.filter(p => p.categoryId === categoryId);
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-full max-w-5xl">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-blue-600">${category.nameAr}</h2>
            <button onclick="this.closest('.modal-overlay').remove()" class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-700 transition">âœ•</button>
          </div>
          
          <div class="flex gap-3 mb-6">
            <button onclick="showAddProductToCategoryModal('${categoryId}')" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
            <button onclick="showAddCategoryModal('${categoryId}')" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition">Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… ÙØ±Ø¹ÙŠ</button>
            <button onclick="editCategory('${categoryId}')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 transition">ØªØ¹Ø¯ÙŠÙ„</button>
            <button onclick="confirmDeleteCategory('${categoryId}')" class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-700 transition">Ø­Ø°Ù</button>
          </div>
          
          ${subCategories.length > 0 ? `
            <h3 class="text-xl font-bold mb-4">Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ©</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              ${subCategories.map(subCat => `
                <div class="category-card cursor-pointer" onclick="this.closest('.modal-overlay').remove(); viewCategory('${subCat.id}')">
                  <div class="text-3xl mb-2">ğŸ“</div>
                  <div class="font-bold">${subCat.nameAr}</div>
                  <div class="text-sm opacity-80">${subCat.nameEn}</div>
                </div>
              `).join('')}
            </div>
          ` : ''}
          
          <h3 class="text-xl font-bold mb-4">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 max-h-96 overflow-y-auto">
            ${products.map(prod => `
              <div class="product-card">
                <div class="text-3xl mb-2">ğŸ“¦</div>
                <div class="font-bold mb-1">${prod.nameAr}</div>
                <div class="text-blue-600 font-bold">${prod.price.toFixed(3)} Ø¯.Ùƒ</div>
                <button onclick="removeProductFromCategory('${prod.id}', '${categoryId}')" class="mt-2 bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition">Ø¥Ø²Ø§Ù„Ø©</button>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function showAddCategoryModal(parentId) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-full max-w-lg">
          <h2 class="text-2xl font-bold text-blue-600 mb-6">${parentId ? 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… ÙØ±Ø¹ÙŠ' : 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯'}</h2>
          <div class="space-y-4">
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ</label>
              <input type="text" id="newCategoryNameAr" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
            </div>
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</label>
              <input type="text" id="newCategoryNameEn" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
            </div>
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="addCategory('${parentId || ''}')" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition">Ø¥Ø¶Ø§ÙØ©</button>
            <button onclick="this.closest('.modal-overlay').remove(); ${parentId ? `viewCategory('${parentId}')` : `renderAccounting('categories')`}" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function addCategory(parentId) {
      const nameAr = document.getElementById('newCategoryNameAr').value.trim();
      const nameEn = document.getElementById('newCategoryNameEn').value.trim();
      
      if (!nameAr || !nameEn) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ', true);
        return;
      }
      
      const category = {
        nameAr,
        nameEn,
        parentId: parentId || null
      };
      
      const success = await saveCategory(category);
      if (success) {
        showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­');
        document.querySelector('.modal-overlay').remove();
        if (parentId) {
          viewCategory(parentId);
        } else {
          renderAccounting('categories');
        }
      }
    }

    function editCategory(categoryId) {
      const category = allCategories.find(c => c.id === categoryId);
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-full max-w-lg">
          <h2 class="text-2xl font-bold text-blue-600 mb-6">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…</h2>
          <div class="space-y-4">
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ</label>
              <input type="text" id="editCategoryNameAr" value="${category.nameAr}" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
            </div>
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</label>
              <input type="text" id="editCategoryNameEn" value="${category.nameEn}" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
            </div>
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="saveEditedCategory('${categoryId}')" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition">Ø­ÙØ¸</button>
            <button onclick="this.closest('.modal-overlay').remove(); viewCategory('${categoryId}');" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function saveEditedCategory(categoryId) {
      const nameAr = document.getElementById('editCategoryNameAr').value.trim();
      const nameEn = document.getElementById('editCategoryNameEn').value.trim();
      
      if (!nameAr || !nameEn) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ', true);
        return;
      }
      
      const category = allCategories.find(c => c.id === categoryId);
      category.nameAr = nameAr;
      category.nameEn = nameEn;
      
      const success = await saveCategory(category);
      if (success) {
        showToast('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­');
        document.querySelector('.modal-overlay').remove();
        viewCategory(categoryId);
      }
    }

    function confirmDeleteCategory(categoryId) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-96 text-center">
          <h2 class="text-2xl font-bold text-red-600 mb-4">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h2>
          <p class="text-gray-600 mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…ØŸ</p>
          <div class="flex gap-3">
            <button onclick="deleteCategoryConfirmed('${categoryId}')" class="flex-1 bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition">Ù†Ø¹Ù…</button>
            <button onclick="this.closest('.modal-overlay').remove(); viewCategory('${categoryId}');" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ù„Ø§</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function deleteCategoryConfirmed(categoryId) {
      const success = await deleteCategory(categoryId);
      if (success) {
        document.querySelector('.modal-overlay').remove();
        renderAccounting('categories');
        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­');
      }
    }

    function showAddProductToCategoryModal(categoryId) {
  selectedProductsForCategory = [];
  const availableProducts = allProducts.filter(p => !p.categoryId || p.categoryId === null);
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content p-8 w-full max-w-4xl">
      <h2 class="text-2xl font-bold text-blue-600 mb-6">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ù‚Ø³Ù…</h2>
      <input type="text" id="addProductSearch" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." oninput="filterAddProducts()" class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 focus:border-blue-600 focus:outline-none">
      
      <div class="bg-blue-50 p-3 rounded-lg mb-4" id="selectedCountBadge" style="display: none;">
        <span class="font-bold text-blue-600" id="selectedCount">0</span> Ù…Ù†ØªØ¬ Ù…Ø­Ø¯Ø¯
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 max-h-96 overflow-y-auto" id="productsGridForCategory">
        ${availableProducts.map(prod => `
          <div class="product-card add-product-card border-2" data-search="${prod.nameAr} ${prod.nameEn}" data-product-id="${prod.id}" onclick="toggleProductSelection('${prod.id}', '${categoryId}')" style="border-color: #e5e7eb;">
            <div class="text-3xl mb-2">ğŸ“¦</div>
            <div class="font-bold mb-1">${prod.nameAr}</div>
            <div class="text-blue-600 font-bold">${prod.price.toFixed(3)} Ø¯.Ùƒ</div>
          </div>
        `).join('')}
      </div>
      
      <div class="flex gap-3 mt-6">
        <button id="addSelectedBtn" onclick="addSelectedProductsToCategory('${categoryId}')" disabled class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</button>
        <button onclick="this.closest('.modal-overlay').remove(); viewCategory('${categoryId}');" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

    function filterAddProducts() {
  const searchTerm = document.getElementById('addProductSearch').value.toLowerCase();
  const cards = document.querySelectorAll('.add-product-card');
  
  cards.forEach(card => {
    const searchData = card.getAttribute('data-search').toLowerCase();
    if (searchData.includes(searchTerm)) {
      card.style.display = '';
    } else {
      card.style.display = 'none';
    }
  });
}

function toggleProductSelection(productId, categoryId) {
  const card = document.querySelector(`[data-product-id="${productId}"]`);
  
  if (selectedProductsForCategory.includes(productId)) {
    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
    selectedProductsForCategory = selectedProductsForCategory.filter(id => id !== productId);
    card.style.borderColor = '#e5e7eb';
    card.style.backgroundColor = 'white';
  } else {
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†ØªØ¬
    selectedProductsForCategory.push(productId);
    card.style.borderColor = '#3b82f6';
    card.style.backgroundColor = '#dbeafe';
  }
  
  // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
  document.getElementById('selectedCount').textContent = selectedProductsForCategory.length;
  const badge = document.getElementById('selectedCountBadge');
  const addBtn = document.getElementById('addSelectedBtn');
  
  if (selectedProductsForCategory.length > 0) {
    badge.style.display = '';
    addBtn.disabled = false;
  } else {
    badge.style.display = 'none';
    addBtn.disabled = true;
  }
}

    async function addSelectedProductsToCategory(categoryId) {
  if (selectedProductsForCategory.length === 0) {
    showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', true);
    return;
  }
  
  const addBtn = document.getElementById('addSelectedBtn');
  addBtn.disabled = true;
  addBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...';
  
  let successCount = 0;
  
  for (const productId of selectedProductsForCategory) {
    const product = allProducts.find(p => p.id === productId);
    product.categoryId = categoryId;
    
    const success = await saveProduct(product);
    if (success) {
      successCount++;
    }
  }
  
  showToast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${successCount} Ù…Ù†ØªØ¬ Ù„Ù„Ù‚Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­`);
  document.querySelector('.modal-overlay').remove();
  viewCategory(categoryId);
}

    async function removeProductFromCategory(productId, categoryId) {
  const product = allProducts.find(p => p.id === productId);
  product.categoryId = null;
  
  const success = await saveProduct(product);
  if (success) {
    showToast('ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ù‚Ø³Ù…');
    viewCategory(categoryId);
  }
}

    // Devices and Cashiers Section
    function renderDevicesSection() {
      // Get current device info
      const currentDeviceId = getDeviceId();
      const currentDeviceBranch = localStorage.getItem('deviceBranch');
      
      // Send heartbeat to mark device as online
      updateDeviceHeartbeat(currentDeviceId, currentDeviceBranch);
      
      return `
        <div>
          <h2 class="text-3xl font-bold text-blue-600 mb-6">Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ÙˆØ§Ù„ÙƒØ§Ø´ÙŠØ±</h2>
          
          <!-- Current Device Section -->
          <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ–¥ï¸ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
            <div class="bg-blue-50 p-4 rounded-lg">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <div class="text-sm text-gray-600">Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø²</div>
                  <div class="font-bold text-gray-800">${currentDeviceId.substr(0, 20)}...</div>
                </div>
                <div>
                  <div class="text-sm text-gray-600">Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯</div>
                  <div class="font-bold text-blue-600">${currentDeviceBranch || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                </div>
              </div>
              <div class="mt-4">
                <label class="block mb-2 font-bold text-gray-700">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ±Ø¹</label>
                <div class="flex gap-2">
                  <select id="currentDeviceBranch" class="flex-1 p-2 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹</option>
                    <option value="Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ" ${currentDeviceBranch === 'Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ' ? 'selected' : ''}>Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>
                    <option value="Ø£Ø¨Ùˆ Ø§Ù„Ø­ØµØ§Ù†ÙŠØ©" ${currentDeviceBranch === 'Ø£Ø¨Ùˆ Ø§Ù„Ø­ØµØ§Ù†ÙŠØ©' ? 'selected' : ''}>Ø£Ø¨Ùˆ Ø§Ù„Ø­ØµØ§Ù†ÙŠØ©</option>
                    <option value="Ø§Ù„ÙŠØ±Ù…ÙˆÙƒ" ${currentDeviceBranch === 'Ø§Ù„ÙŠØ±Ù…ÙˆÙƒ' ? 'selected' : ''}>Ø§Ù„ÙŠØ±Ù…ÙˆÙƒ</option>
                  </select>
                  <button onclick="assignCurrentDeviceBranch()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition">Ø­ÙØ¸</button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- All Devices Section -->
          <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</h3>
            <div id="devicesListContainer">
              ${renderDevicesList()}
            </div>
          </div>
          
          <!-- Cashiers Section -->
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-bold text-gray-800">Ø§Ù„ÙƒØ§Ø´ÙŠØ±Ø§Øª</h3>
              <button onclick="showAddCashierModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition">â• Ø¥Ø¶Ø§ÙØ© ÙƒØ§Ø´ÙŠØ±</button>
            </div>
            <div class="overflow-x-auto">
              <table>
                <thead>
                  <tr>
                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                    <th>Ø§Ù„Ø±Ù…Ø²</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                  </tr>
                </thead>
                <tbody>
                  ${allCashiers.map(cashier => `
                    <tr>
                      <td>${cashier.name}</td>
                      <td>${cashier.code}</td>
                      <td>
                        <button onclick="editCashier('${cashier.id}')" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button onclick="confirmDeleteCashier('${cashier.id}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition">Ø­Ø°Ù</button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }
    
    function renderDevicesList() {
      const devices = JSON.parse(localStorage.getItem('allDevices') || '{}');
      const currentTime = Date.now();
      const onlineThreshold = 5 * 60 * 1000; // 5 minutes
      
      const devicesList = Object.entries(devices).map(([deviceId, data]) => {
        const isOnline = data.lastSeen && (currentTime - data.lastSeen) < onlineThreshold;
        const isCurrent = deviceId === getDeviceId();
        
        return `
          <div class="bg-gray-50 p-4 rounded-lg mb-2 ${isCurrent ? 'border-2 border-blue-500' : ''}">
            <div class="flex justify-between items-center">
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <div class="font-bold">${deviceId.substr(0, 25)}...</div>
                  ${isCurrent ? '<span class="text-xs bg-blue-600 text-white px-2 py-1 rounded">Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø­Ø§Ù„ÙŠ</span>' : ''}
                  ${isOnline ? '<span class="text-xs bg-green-600 text-white px-2 py-1 rounded">Ù…ØªØµÙ„</span>' : '<span class="text-xs bg-gray-400 text-white px-2 py-1 rounded">ØºÙŠØ± Ù…ØªØµÙ„</span>'}
                </div>
                <div class="text-sm text-gray-600 mt-1">
                  Ø§Ù„ÙØ±Ø¹: <span class="font-bold text-blue-600">${data.branch || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                </div>
              </div>
              <button onclick="unassignDevice('${deviceId}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¨Ø·</button>
            </div>
          </div>
        `;
      }).join('');
      
      return devicesList || '<div class="text-center text-gray-400 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¬Ù‡Ø²Ø© Ù…Ø¹Ø±ÙØ©</div>';
    }
    
    function assignCurrentDeviceBranch() {
      const branch = document.getElementById('currentDeviceBranch').value;
      
      if (!branch) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙØ±Ø¹', true);
        return;
      }
      
      const deviceId = getDeviceId();
      localStorage.setItem('deviceBranch', branch);
      
      // Update devices list
      const devices = JSON.parse(localStorage.getItem('allDevices') || '{}');
      devices[deviceId] = {
        branch: branch,
        lastSeen: Date.now()
      };
      localStorage.setItem('allDevices', JSON.stringify(devices));
      
      showToast('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ±Ø¹ Ù„Ù„Ø¬Ù‡Ø§Ø² Ø¨Ù†Ø¬Ø§Ø­');
      renderAccounting('devices');
    }
    
    function updateDeviceHeartbeat(deviceId, branch) {
      if (!branch) return;
      
      const devices = JSON.parse(localStorage.getItem('allDevices') || '{}');
      devices[deviceId] = {
        branch: branch,
        lastSeen: Date.now()
      };
      localStorage.setItem('allDevices', JSON.stringify(devices));
    }
    
    function unassignDevice(deviceId) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-96 text-center">
          <h2 class="text-2xl font-bold text-red-600 mb-4">ØªØ£ÙƒÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¨Ø·</h2>
          <p class="text-gray-600 mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø±Ø¨Ø· Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ</p>
          <div class="flex gap-3">
            <button onclick="confirmUnassignDevice('${deviceId}')" class="flex-1 bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition">Ù†Ø¹Ù…</button>
            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ù„Ø§</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    function confirmUnassignDevice(deviceId) {
      const devices = JSON.parse(localStorage.getItem('allDevices') || '{}');
      delete devices[deviceId];
      localStorage.setItem('allDevices', JSON.stringify(devices));
      
      // If unassigning current device
      if (deviceId === getDeviceId()) {
        localStorage.removeItem('deviceBranch');
      }
      
      document.querySelector('.modal-overlay').remove();
      showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø²');
      renderAccounting('devices');
    }

    function showAddCashierModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-full max-w-lg">
          <h2 class="text-2xl font-bold text-blue-600 mb-6">Ø¥Ø¶Ø§ÙØ© ÙƒØ§Ø´ÙŠØ± Ø¬Ø¯ÙŠØ¯</h2>
          <div class="space-y-4">
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ù„Ø§Ø³Ù…</label>
              <input type="text" id="newCashierName" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
            </div>
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ù„Ø±Ù…Ø²</label>
              <div class="flex gap-2">
                <input type="text" id="newCashierCode" class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                <button onclick="generateCashierCode()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥Ù†Ø´Ø§Ø¡</button>
              </div>
            </div>
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="addCashier()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition">Ø¥Ø¶Ø§ÙØ©</button>
            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function generateCashierCode() {
      const code = Math.floor(1000 + Math.random() * 9000).toString();
      document.getElementById('newCashierCode').value = code;
    }

    async function addCashier() {
      const name = document.getElementById('newCashierName').value.trim();
      const code = document.getElementById('newCashierCode').value.trim();
      
      if (!name || !code) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù…Ø²', true);
        return;
      }
      
      const cashier = { name, code };
      
      const success = await saveCashier(cashier);
      if (success) {
        showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØ§Ø´ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­');
        document.querySelector('.modal-overlay').remove();
        renderAccounting('devices');
      }
    }

    function editCashier(cashierId) {
      const cashier = allCashiers.find(c => c.id === cashierId);
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-full max-w-lg">
          <h2 class="text-2xl font-bold text-blue-600 mb-6">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ø´ÙŠØ±</h2>
          <div class="space-y-4">
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ù„Ø§Ø³Ù…</label>
              <input type="text" id="editCashierName" value="${cashier.name}" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
            </div>
            <div>
              <label class="block mb-2 font-bold text-gray-700">Ø§Ù„Ø±Ù…Ø²</label>
              <input type="text" id="editCashierCode" value="${cashier.code}" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
            </div>
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="saveEditedCashier('${cashierId}')" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition">Ø­ÙØ¸</button>
            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function saveEditedCashier(cashierId) {
      const name = document.getElementById('editCashierName').value.trim();
      const code = document.getElementById('editCashierCode').value.trim();
      
      if (!name || !code) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù…Ø²', true);
        return;
      }
      
      const cashier = allCashiers.find(c => c.id === cashierId);
      cashier.name = name;
      cashier.code = code;
      
      const success = await saveCashier(cashier);
      if (success) {
        showToast('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ø´ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­');
        document.querySelector('.modal-overlay').remove();
        renderAccounting('devices');
      }
    }

    function confirmDeleteCashier(cashierId) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8 w-96 text-center">
          <h2 class="text-2xl font-bold text-red-600 mb-4">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h2>
          <p class="text-gray-600 mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒØ§Ø´ÙŠØ±ØŸ</p>
          <div class="flex gap-3">
            <button onclick="deleteCashierConfirmed('${cashierId}')" class="flex-1 bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition">Ù†Ø¹Ù…</button>
            <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Ù„Ø§</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function deleteCashierConfirmed(cashierId) {
      const success = await deleteCashier(cashierId);
      if (success) {
        document.querySelector('.modal-overlay').remove();
        renderAccounting('devices');
        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒØ§Ø´ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­');
      }
    }


    function showNumericKeypad(inputField) {
  if (document.querySelector('.numeric-keypad-overlay')) return;
  
  const overlay = document.createElement('div');
  overlay.className = 'numeric-keypad-overlay';
  overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
  
  const keypad = document.createElement('div');
  keypad.style.cssText = 'background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);';
  
  const display = document.createElement('input');
  display.type = 'text';
  display.value = inputField.value || '0';
  display.readOnly = true;
  display.style.cssText = 'width: 100%; font-size: 32px; text-align: center; padding: 15px; margin-bottom: 15px; border: 2px solid #2563eb; border-radius: 8px; font-weight: bold;';
  
  const buttonsContainer = document.createElement('div');
  buttonsContainer.style.cssText = 'display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 300px;';

  
  const buttons = ['7', '8', '9', '4', '5', '6', '1', '2', '3', '.', '0', 'Ù…Ø³Ø­', 'Ù…ÙˆØ§ÙÙ‚'];

  
  buttons.forEach(btn => {
    const button = document.createElement('button');
    button.textContent = btn;
    button.style.cssText = 'padding: 20px; font-size: 24px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s;';
    
    if (btn === 'Ù…ÙˆØ§ÙÙ‚') {
      button.style.background = '#22c55e';
      button.style.color = 'white';
    } else if (btn === 'Ù…Ø³Ø­') {
      button.style.background = '#ef4444';
      button.style.color = 'white';
    } else {
      button.style.background = '#e5e7eb';
      button.style.color = '#1f2937';
    }
    
    button.onmouseover = () => {
      button.style.transform = 'scale(1.05)';
      button.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
    };
    
    button.onmouseout = () => {
      button.style.transform = 'scale(1)';
      button.style.boxShadow = 'none';
    };
    
    button.onclick = () => {
  if (btn === 'Ù…ÙˆØ§ÙÙ‚') {
    inputField.value = display.value;
    overlay.remove();
  } else if (btn === 'Ù…Ø³Ø­') {
    display.value = '0';
  } else if (btn === '.') {
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… 0ØŒ ÙŠØµØ¨Ø­ 0.
    if (display.value === '0') {
      display.value = '0.';
    } 
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ÙØ§ØµÙ„Ø© Ø¨Ø§Ù„ÙØ¹Ù„
    else if (!display.value.includes('.')) {
      display.value += '.';
    }
  } else {
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… 0ØŒ Ø§Ø³ØªØ¨Ø¯Ù„Ù‡ Ø¨Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
    if (display.value === '0') {
      display.value = btn;
    } else {
      display.value += btn;
    }
  }
};
    
    buttonsContainer.appendChild(button);
  });
  
  keypad.appendChild(display);
  keypad.appendChild(buttonsContainer);
  overlay.appendChild(keypad);
  
  overlay.onclick = (e) => {
    if (e.target === overlay) overlay.remove();
  };
  
  document.body.appendChild(overlay);
}



// Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
async function editOrder(orderId) {
  const order = allOrders.find(o => o.id === orderId);
  if (!order) {
    showToast('Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
    return;
  }
  
  currentEditingOrder = JSON.parse(JSON.stringify(order)); // Ù†Ø³Ø®Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
  
  const modal = document.getElementById('editOrderModal');
  modal.style.display = 'flex';
  
  // Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  document.getElementById('editCustomerName').value = order.customerName || '';
  document.getElementById('editPhoneNumber').value = order.phoneNumber || '';
  document.getElementById('editAddress').value = order.address || '';
  document.getElementById('editDeliveryFee').value = parseFloat(order.deliveryFee || order.deliveryPrice || 0).toFixed(3);
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
  renderEditProducts();
}

// Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
function renderEditProducts() {
  const container = document.getElementById('editProductsList');
  
  let html = `
    <div class="space-y-3">
      ${currentEditingOrder.items.map((item, index) => `
        <div class="flex gap-2 items-center bg-gray-50 p-3 rounded-lg">
          <span class="flex-1 font-bold">${item.productName}</span>
          <input type="number" value="${item.quantity}" onchange="updateEditProduct(${index}, 'quantity', this.value)" class="w-20 p-2 border rounded-lg" step="0.001">
          <select onchange="updateEditProduct(${index}, 'unit', this.value)" class="p-2 border rounded-lg">
            <option value="Ø­Ø¨Ø©" ${item.unit === 'Ø­Ø¨Ø©' ? 'selected' : ''}>Ø­Ø¨Ø©</option>
            <option value="ÙƒØ±ØªÙˆÙ†" ${item.unit === 'ÙƒØ±ØªÙˆÙ†' ? 'selected' : ''}>ÙƒØ±ØªÙˆÙ†</option>
            <option value="ÙƒÙŠÙ„Ùˆ" ${item.unit === 'ÙƒÙŠÙ„Ùˆ' ? 'selected' : ''}>ÙƒÙŠÙ„Ùˆ</option>
          </select>
          <input type="number" value="${item.price}" onchange="updateEditProduct(${index}, 'price', this.value)" class="w-24 p-2 border rounded-lg" step="0.001">
          <span class="font-bold text-blue-600 w-24 text-center">${(item.total || 0).toFixed(3)} Ø¯.Ùƒ</span>
          <button onclick="removeEditProduct(${index})" class="bg-red-600 text-white px-3 py-2 rounded-lg hover:bg-red-700">Ø­Ø°Ù</button>
        </div>
      `).join('')}
    </div>
    
    <div class="mt-6 p-4 bg-green-50 rounded-lg">
      <h4 class="font-bold text-lg mb-3">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h4>
      
      <div class="mb-3">
        <input type="text" id="searchProductInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." class="w-full p-3 border-2 border-green-600 rounded-lg" oninput="searchProducts()">
        <div id="productSearchResults" class="mt-2 max-h-48 overflow-y-auto"></div>
      </div>
      
      <div id="selectedProductInfo" class="hidden">
        <div class="bg-white p-3 rounded-lg mb-3">
          <p class="font-bold text-green-600 mb-2">Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø®ØªØ§Ø±: <span id="selectedProductName"></span></p>
          <div class="grid grid-cols-3 gap-2">
            <div>
              <label class="block text-sm font-bold mb-1">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
              <input type="number" id="selectedProductQty" class="w-full p-2 border rounded-lg" step="0.001" value="1">
            </div>
            <div>
              <label class="block text-sm font-bold mb-1">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
              <select id="selectedProductUnit" class="w-full p-2 border rounded-lg">
                <option value="Ø­Ø¨Ø©">Ø­Ø¨Ø©</option>
                <option value="ÙƒØ±ØªÙˆÙ†">ÙƒØ±ØªÙˆÙ†</option>
                <option value="ÙƒÙŠÙ„Ùˆ">ÙƒÙŠÙ„Ùˆ</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-bold mb-1">Ø§Ù„Ø³Ø¹Ø±</label>
              <input type="number" id="selectedProductPrice" class="w-full p-2 border rounded-lg" step="0.001">
            </div>
          </div>
        </div>
        <button onclick="addSelectedProduct()" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 font-bold">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„ÙØ§ØªÙˆØ±Ø©</button>
      </div>
    </div>
    
    <div class="mt-4 p-4 bg-blue-50 rounded-lg">
      <div class="flex justify-between text-lg font-bold">
        <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
        <span class="text-blue-600">${calculateEditTotal().toFixed(3)} Ø¯.Ùƒ</span>
      </div>
    </div>
  `;
  
  container.innerHTML = html;
}

// ØªØ­Ø¯ÙŠØ« Ù…Ù†ØªØ¬
function updateEditProduct(index, field, value) {
  if (field === 'quantity' || field === 'price') {
    currentEditingOrder.items[index][field] = parseFloat(value) || 0;
    currentEditingOrder.items[index].total = currentEditingOrder.items[index].quantity * currentEditingOrder.items[index].price;
  } else {
    currentEditingOrder.items[index][field] = value;
  }
  renderEditProducts();
}

// Ø­Ø°Ù Ù…Ù†ØªØ¬
function removeEditProduct(index) {
  if (currentEditingOrder.items.length <= 1) {
    showToast('ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
    return;
  }
  currentEditingOrder.items.splice(index, 1);
  renderEditProducts();
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
function addEditProduct() {
  const name = document.getElementById('newProductName').value.trim();
  const qty = parseFloat(document.getElementById('newProductQty').value) || 1;
  const unit = document.getElementById('newProductUnit').value;
  const price = parseFloat(document.getElementById('newProductPrice').value) || 0;
  
  if (!name) {
    showToast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬');
    return;
  }
  
  const newProduct = {
    productName: name,
    quantity: qty,
    unit: unit,
    price: price,
    total: qty * price
  };
  
  currentEditingOrder.items.push(newProduct);
  
  // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
  document.getElementById('newProductName').value = '';
  document.getElementById('newProductQty').value = '1';
  document.getElementById('newProductPrice').value = '';
  
  renderEditProducts();
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
function calculateEditTotal() {
  const itemsTotal = currentEditingOrder.items.reduce((sum, item) => sum + (item.total || 0), 0);
  const deliveryFee = parseFloat(document.getElementById('editDeliveryFee').value) || 0;
  return itemsTotal + deliveryFee;
}

// Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
async function saveOrderEdit() {
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  currentEditingOrder.customerName = document.getElementById('editCustomerName').value.trim();
  currentEditingOrder.phoneNumber = document.getElementById('editPhoneNumber').value.trim();
  currentEditingOrder.address = document.getElementById('editAddress').value.trim();
  currentEditingOrder.deliveryFee = parseFloat(document.getElementById('editDeliveryFee').value) || 0;
  currentEditingOrder.deliveryPrice = currentEditingOrder.deliveryFee;
  currentEditingOrder.total = calculateEditTotal();
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  if (!currentEditingOrder.customerName) {
    showToast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„');
    return;
  }
  if (!currentEditingOrder.phoneNumber) {
    showToast('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ');
    return;
  }
  if (currentEditingOrder.items.length === 0) {
    showToast('ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
    return;
  }
  
  // Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  const result = await window.dataSdk.update(currentEditingOrder);
  
  if (result.isOk) {
    showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­');
    closeEditOrderModal();
  } else {
    showToast('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + result.error.message);
  }
}

// Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
function closeEditOrderModal() {
  document.getElementById('editOrderModal').style.display = 'none';
  currentEditingOrder = null;
}

let currentEditingOrder = null;



let selectedProduct = null;

function searchProducts() {
  const searchTerm = document.getElementById('searchProductInput').value.trim().toLowerCase();
  const resultsContainer = document.getElementById('productSearchResults');
  
  if (!searchTerm) {
    resultsContainer.innerHTML = '';
    return;
  }
  
  if (!allProducts || allProducts.length === 0) {
    resultsContainer.innerHTML = '<p class="text-red-500 p-2 bg-white rounded">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª!</p>';
    return;
  }
  
  // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ nameAr Ùˆ nameEn Ùˆ id
  const filteredProducts = allProducts.filter(p => {
    if (!p) return false;
    
    const searchIn = [
      p.nameAr,
      p.nameEn,
      p.id
    ].filter(v => v).join(' ').toLowerCase();
    
    return searchIn.includes(searchTerm);
  });
  
  if (filteredProducts.length === 0) {
    resultsContainer.innerHTML = `<p class="text-gray-500 p-2 bg-white rounded">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† "${searchTerm}"</p>`;
    return;
  }
  
  resultsContainer.innerHTML = filteredProducts.slice(0, 10).map(product => {
    const productData = {
      id: product.id || '',
      name: product.nameAr || product.nameEn || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…',
      code: product.id || 'N/A',
      unit: product.unit || 'Ø­Ø¨Ø©',
      sellPrice: product.price || 0,
      quantity: product.stock || 0
    };
    
    return `
      <div class="bg-white p-3 mb-2 rounded-lg border-2 border-gray-200 hover:border-green-600 cursor-pointer transition" onclick='selectProductFromSearch(${JSON.stringify(productData).replace(/'/g, "&apos;")})'>
        <div class="flex justify-between items-center">
          <div>
            <p class="font-bold">${productData.name}</p>
            <p class="text-sm text-gray-600">${product.nameEn || ''}</p>
          </div>
          <div class="text-left">
            <p class="font-bold text-green-600">${productData.sellPrice.toFixed(3)} Ø¯.Ùƒ</p>
            <p class="text-xs text-gray-500">Ù…ØªÙˆÙØ±: ${productData.quantity} ${productData.unit}</p>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function selectProductFromSearch(product) {
  selectedProduct = product;
  
  document.getElementById('selectedProductName').textContent = product.name;
  document.getElementById('selectedProductQty').value = '1';
  document.getElementById('selectedProductUnit').value = product.unit;
  document.getElementById('selectedProductPrice').value = product.sellPrice.toFixed(3);
  document.getElementById('selectedProductInfo').classList.remove('hidden');
  document.getElementById('productSearchResults').innerHTML = '';
  document.getElementById('searchProductInput').value = '';
}

function addSelectedProduct() {
  if (!selectedProduct) {
    showToast('Ø§Ø®ØªØ± Ù…Ù†ØªØ¬ Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }
  
  const qty = parseFloat(document.getElementById('selectedProductQty').value) || 1;
  const unit = document.getElementById('selectedProductUnit').value;
  const price = parseFloat(document.getElementById('selectedProductPrice').value) || 0;
  
  const newProduct = {
    productName: selectedProduct.name,
    productCode: selectedProduct.code,
    quantity: qty,
    unit: unit,
    price: price,
    total: qty * price
  };
  
  currentEditingOrder.items.push(newProduct);
  
  selectedProduct = null;
  document.getElementById('selectedProductInfo').classList.add('hidden');
  
  renderEditProducts();
  showToast('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„ÙØ§ØªÙˆØ±Ø©');
}




    // Initialize App
    renderHome();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b8b60cd22e47cc9',t:'MTc2NzUzNjQ0My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
 
 
 <div id="editOrderModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
  <div style="background: white; border-radius: 20px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; direction: rtl;">
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 20px 20px 0 0;">
      <h2 style="margin: 0; font-size: 24px; font-weight: bold;">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h2>
    </div>
    <div style="padding: 30px;">
      <div style="margin-bottom: 30px;">
        <h3 style="font-size: 20px; font-weight: bold; margin-bottom: 15px; color: #667eea;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
            <input type="text" id="editCustomerName" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
            <input type="tel" id="editPhoneNumber" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
            <input type="text" id="editAddress" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø¯.Ùƒ)</label>
            <input type="number" id="editDeliveryFee" step="0.001" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px;" onchange="renderEditProducts()">
          </div>
        </div>
      </div>
      <div>
        <h3 style="font-size: 20px; font-weight: bold; margin-bottom: 15px; color: #667eea;">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
        <div id="editProductsList"></div>
      </div>
      <div style="display: flex; gap: 10px; margin-top: 30px;">
        <button onclick="saveOrderEdit()" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer;">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <button onclick="closeEditOrderModal()" style="flex: 1; background: #6b7280; color: white; padding: 15px; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer;">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>
</div>
 
 
 
 
 </body>
</html>
